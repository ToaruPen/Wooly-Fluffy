#!/bin/sh
set -eu

if ! command -v python3 >/dev/null 2>&1; then
  echo "[agentic-sdd gate] BLOCKED: python3 is required for approval validation." >&2
  exit 1
fi

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$ROOT" ]; then
  exit 0
fi

cd "$ROOT"

approval_py=""
worktree_py=""
if [ -f "scripts/agentic-sdd/validate-approval.py" ] && [ -f "scripts/agentic-sdd/validate-worktree.py" ]; then
  approval_py="scripts/agentic-sdd/validate-approval.py"
  worktree_py="scripts/agentic-sdd/validate-worktree.py"
elif [ -f "scripts/validate-approval.py" ] && [ -f "scripts/validate-worktree.py" ]; then
  approval_py="scripts/validate-approval.py"
  worktree_py="scripts/validate-worktree.py"
fi

if [ -z "$approval_py" ] || [ -z "$worktree_py" ]; then
  if [ -f "scripts/agentic-sdd/validate-approval.py" ] || [ -f "scripts/validate-approval.py" ]; then
    echo "[agentic-sdd gate] BLOCKED: validate-worktree.py is missing. Reinstall/upgrade Agentic-SDD." >&2
  elif [ -f "scripts/agentic-sdd/validate-worktree.py" ] || [ -f "scripts/validate-worktree.py" ]; then
    echo "[agentic-sdd gate] BLOCKED: validate-approval.py is missing. Reinstall/upgrade Agentic-SDD." >&2
  else
    echo "[agentic-sdd gate] BLOCKED: validator pair is missing. Reinstall/upgrade Agentic-SDD." >&2
  fi
  exit 1
fi

python3 "$worktree_py"
python3 "$approval_py"

# Python lint gate (Stage 1): ruff
need_ruff=0
zero="0000000000000000000000000000000000000000"
while read -r local_ref local_sha _remote_ref remote_sha; do
  [ -n "$local_ref" ] || continue
  if [ "$local_sha" = "$zero" ]; then
    continue
  fi
  if [ "$remote_sha" = "$zero" ]; then
    # New branch on remote: inspect all commits that are not present in any remote ref
    # to avoid missing Python changes in non-tip commits (including when pre-commit was bypassed).
    commits="$(git rev-list "$local_sha" --not --remotes 2>/dev/null || true)"
    if [ -z "$commits" ]; then
      # No new commits to push (the ref points to an already-remote commit).
      # Skip gating to avoid blocking branch creation for already-verified commits.
      continue
    fi
    for c in $commits; do
      if git diff-tree --no-commit-id --name-only -r --root "$c" 2>/dev/null \
        | grep -Eq '^scripts/.*\.py$|^pyproject\.toml$|^requirements-dev\.txt$'; then
        need_ruff=1
        break
      fi
    done
    continue
  fi
  if git diff --name-only "$remote_sha..$local_sha" --diff-filter=ACMR 2>/dev/null \
    | grep -Eq '^scripts/.*\.py$|^pyproject\.toml$|^requirements-dev\.txt$'; then
    need_ruff=1
    break
  fi
done

if [ "$need_ruff" -eq 1 ]; then
  ruff_cmd=""
  if command -v ruff >/dev/null 2>&1; then
    ruff_cmd="ruff"
  elif python3 -m ruff --version >/dev/null 2>&1; then
    ruff_cmd="python3 -m ruff"
  else
    echo "[agentic-sdd gate] BLOCKED: ruff is required for Python lint." >&2
    echo "[agentic-sdd gate] Install: python3 -m pip install -r requirements-dev.txt" >&2
    exit 1
  fi
  # shellcheck disable=SC2086
  $ruff_cmd check scripts
  # shellcheck disable=SC2086
  $ruff_cmd format --check scripts
fi
