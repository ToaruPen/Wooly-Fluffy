# Epic: Wooly-Fluffy UI リデザイン（KIOSK / STAFF）

---

## メタ情報

- 作成日: 2026-02-06
- 作成者: -
- ステータス: Completed
- 参照PRD: `docs/prd/wooly-fluffy.md`

---

## 1. 概要

### 1.1 目的

KIOSK（子ども向け）/ STAFF（職員向け）のブラウザUIを、運用の安全性（誤操作防止/視認性/アクセシビリティ）と、キャラクター体験の一貫性を損なわない範囲でブラッシュアップする。

このEpicは「見た目・レイアウト・インタラクション・文言」の改善に限定し、PRDの主要フロー（KIOSK PTT、同意、pending確認、アクセス制御、SSE契約）とデータ最小化方針は変更しない。

入力資料（SoT外）:

- `docs/memo/ui-redesign-plan.md`

### 1.2 スコープ

**含む:**

- CSS変数（色/タイポ/余白/サイズ）を導入し、KIOSK/STAFFで一貫したトークン運用にする
- KIOSK UI: 背景、ステージ周辺、録音表示、スピーチバブル、同意モーダルの見た目/誤操作防止を改善
- STAFF UI: ログイン画面、ステータス表示、セッションリセット/緊急停止、pendingカードの見た目/操作性を改善
- レスポンシブ改善（複数ブレークポイント）
- アクセシビリティ改善（focus-visible、コントラスト、reduced motion）
- 開発者向け技術ラベル（例: Stream/TTS表示）の扱いを整理（本番非表示/開発時のみ表示）
- DEV向けのデバッグ表示（エラー/接続状態/tool calling 等のメタ情報）を「別タブのデバッグ画面」に集約し、KIOSK/STAFF本体の表示をシンプルに保つ
- 既存自動テスト（Vitest/Playwright）の更新と、UI変更に対するスモークの強化（必要最小限）

**含まない（PRDのスコープ外を継承）:**

- ロジック/状態遷移/Orchestratorの仕様変更
- API契約（エンドポイント/メッセージ型/データ形式）の変更
- Tailwind、コンポーネントライブラリ、Storybook、Cypress の導入
- ダークモード対応（将来検討に留める）
- 監査ログ要件の追加

### 1.3 PRD制約の確認

項目: 規模感
PRDの値: 小規模
Epic対応: 既存構造（2ページ + CSS Modules）を維持し、変更範囲を `web/` に限定する

項目: 技術方針
PRDの値: シンプル優先
Epic対応: 既存の Vitest/Playwright に寄せ、新規依存を増やさない（原則0）

項目: 既存言語/FW
PRDの値: Yes
Epic対応: TypeScript + React（Vite）+ CSS Modules のまま

項目: デプロイ先
PRDの値: Yes
Epic対応: 常設PCローカル運用 + 同一LAN内ブラウザ。外部通信の増加は抑制する

### 1.4 運用・合意事項（推奨案を採用）

本Epicでは、実装判断がブレやすい点を先に固定する。

- 本番UIは「現場運用に必要な情報だけ」を表示し、技術情報/内部情報（例: Stream URL、TTSプロバイダ名、詳細エラー、tool calling詳細）は出さない
- DEV向けのデバッグ表示は `/debug` に集約し、KIOSK/STAFF本体はシンプルに保つ（別タブで開ける）
- 代表端末プロファイル（固定）
  - KIOSK: 常設のフルHD（1920x1080）非タッチディスプレイ。入力はマウス/キーボード（タッチ前提にしない）
- STAFF: スマホ幅〜デスクトップ。特にスマホでもセッションリセット/緊急停止が成立することを優先
- エラー文言はユーザー別に分ける
  - KIOSK: 子ども向けに短く・安心させる表現（詳細は `/debug`）
  - STAFF: 運用者が次に取るべき行動が分かる表現（必要なら `/debug` を参照）
- E2E（Playwright）は「フレークしないこと」を最優先とし、アニメーションが増えても安定するよう reduced motion を強制する
- 自動テストのセレクタは role/aria を優先し、装飾テキストやDEVラベルに依存しない（UI変更に強い）
- レスポンシブの優先度は STAFF を最優先（スマホでも主要操作が成立する）。KIOSKはフルHD固定表示を主としつつ崩れない範囲を担保する
- Glassmorphism（`backdrop-filter`）は「効けば嬉しい」扱いとし、効かない/重い環境ではフォールバックで視認性を担保する

レスポンシブのブレークポイント（固定）:

- 既定（モバイル）: < 640px
- タブレット縦: >= 640px
- タブレット横: >= 768px
- デスクトップ: >= 1024px
- ワイド: >= 1280px

セマンティクスの凍結（アクセシビリティ/テストの安定化）:

- KIOSK: `aria-label="Mascot stage"` と `aria-label="Kiosk overlay"` は維持する
- KIOSK: 同意モーダルの `role="dialog"` と `aria-label="Consent"` は維持する
- STAFF: 操作ボタン（Reset Session / Resume / Emergency stop）のセマンティクスを維持する
- VRM フォールバック: `data-testid="mascot-stage-fallback"` は維持する

DEVデバッグ画面（/debug）の表示範囲（最小・固定）:

- 表示してよい: 接続状態/直近エラー種別、mode/phase等の状態要約、tool callingの件数とツール名
- 表示しない: 会話全文、音声、STT全文、パスコード、ツール引数（arguments）、個人情報になり得る生データ

---

## 2. 必須提出物（3一覧）

### 2.1 外部サービス一覧

外部サービス-1
名称: なし
用途: -
必須理由: -
代替案: -

補足:

- フォントは外部CDN（Google Fonts等）に依存しない方針を優先する（運用の安定性/外部通信最小化）。

### 2.2 コンポーネント一覧

コンポーネント-1
名称: Web Frontend（KIOSK/STAFF）
責務: 画面表示、入力、アクセシビリティ、UIスモークの安定化
デプロイ形態: 既存の配信形態を踏襲

### 2.3 新規技術一覧

新規技術-1
名称: なし
カテゴリ: -
既存との差: -
導入理由: -

---

## 3. 技術設計

### 3.1 アーキテクチャ概要

システム境界:

- 本Epicは `web/` の見た目/操作性に限定する
- サーバ側（SSE/HTTP/Orchestrator/認証/永続）の責務と契約は変更しない
- 開発者向けのデバッグ表示は DEV のときのみ有効な「デバッグ画面（別タブ）」に集約する（本番は露出しない）

主要データフロー-1
from: Browser（KIOSK/STAFF）
to: API Server
用途: 既存のイベント送信/データ取得（変更なし）
プロトコル: HTTP

主要データフロー-2
from: API Server
to: Browser（KIOSK/STAFF）
用途: 既存の状態/コマンド配信（変更なし）
プロトコル: SSE

### 3.2 技術選定

技術選定-1
カテゴリ: E2E/UIスモーク
選択: Playwright（既存）
理由: 既存の `/kiosk` `/staff` スモークがあり、リグレッションを最小コストで検知できる
代替案（よりシンプル）: E2Eは現状維持（ただしUI変更の安全性が下がる）

技術選定-2
カテゴリ: コンポーネント/スタイル
選択: CSS Modules（既存）+ CSS変数（トークン）
理由: 依存追加無しで一貫性を作り、KIOSK/STAFFでデザイン差分も管理できる
代替案（よりシンプル）: ハードコード継続（ただし変更コスト増/一貫性崩れ）

技術選定-3
カテゴリ: フォント
選択: 外部CDN依存なし（システムフォント中心。追加する場合は同梱配信）
理由: 常設端末/ネットワークに依存せず、外部通信を増やさない
代替案: Google Fonts（見た目は良いが外部依存と初回安定性の課題）

技術選定-4
カテゴリ: DEV向けデバッグ表示の集約
選択: DEVのみ有効な `/debug` 画面（別タブ）を追加し、KIOSK/STAFF本体はデバッグ情報を最小化
理由: 現場UIの視認性/誤操作防止を優先しつつ、開発時の観測性を確保できる
代替案（よりシンプル）: 既存のKIOSK/STAFFヘッダーに出し続ける（ただしUIが散らかり、現場運用で混乱しやすい）

### 3.3 データモデル（概要）

なし（UIの見た目/文言改善であり、永続データは追加しない）

### 3.4 API設計（概要）

なし（既存API契約を維持）

### 3.5 プロジェクト固有指標（任意）

固有指標-1
指標名: UI変更が自動テストで継続的に検証される
測定方法: `npm run -w web test` / `npm run -w web e2e`
目標値: 主要画面（/kiosk, /staff）のスモークがCIで常にパスし、UI変更でフレークしない
Before/After記録方法: CIログ（失敗時は原因が特定できる待機条件/セレクタにする）

固有指標-2
指標名: アクセシビリティの最低限が守られる
測定方法: 手動チェック + Playwrightの最小確認（focus-visible要素の可視、reduced motion動作）
目標値: キーボード操作でフォーカスが見える。`prefers-reduced-motion` で過剰アニメーションが無効化される
Before/After記録方法: 変更点のチェックリストをIssue ACに含める

### 3.6 境界条件（異常系/リソース解放/レース）

対象境界:

- Browser CSS/Rendering: `backdrop-filter` 等の対応差、低スペック端末での描画
- Browser Preferences: `prefers-reduced-motion`
- UIテスト: アニメーション/トランジション起因の待機揺れ
- 既存表示: WebGL未対応時のステージフォールバック
- DEVデバッグ画面: 本番での露出防止、表示内容のデータ最小化

シナリオ-1（互換性）: `backdrop-filter` が無効/重い

- 状況: Glassmorphism表現が無効（または端末で重い）
- 期待: 透明度/境界線/影で視認性を確保し、UI操作は成立する（見た目は劣化してよい）

シナリオ-2（設定）: reduced motion

- 状況: OS/ブラウザ設定で `prefers-reduced-motion: reduce`
- 期待: pulse/ripple 等のアニメーションは無効化され、情報提示は静的表現で代替される

#### 手動デバッグ/目視レビュー（Claude in Chrome）での扱い

位置づけ:

- Claude in Chrome は「手動の目視レビュー/探索的チェック専用」であり、CIの合否判定には使用しない（`web/AGENTS.md` の方針に従う）
- reduced-motion は手動レビューで必須ではないが、E2Eと同条件での再現・アクセシビリティ確認のために「切り替えて確認する」

推奨の確認手順（2パス）:

1. `prefers-reduced-motion: reduce`（動き無し）
   - 目的: アニメーションに依存しない視認性、誤操作防止、レイアウト崩れの確認
2. `prefers-reduced-motion: no-preference`（動き有り）
   - 目的: アニメーション自体の違和感/過剰さ/重さの確認

Chromeでの切り替え例（DevTools）:

- DevTools を開く → Command Menu（例: Cmd/Ctrl+Shift+P）で `Rendering` を開く
- `Emulate CSS media feature prefers-reduced-motion` を `reduce` / `no-preference` に切り替える

シナリオ-3（テスト安定性）: アニメーションによるフレーク

- 状況: Playwrightが遷移/表示直後に要素を検出する際、アニメーションで位置/透明度が変化
- 期待: テストは role/text/aria を中心に待機し、アニメーション有無で不安定にならない

シナリオ-4（安全/誤操作）: 同意モーダル

- 状況: 子どもが誤って同意/否定を押しやすい
- 期待: ボタン配置とサイズで誤操作を減らし、選択肢が明確に区別される（縦並び等）

シナリオ-5（情報露出）: DEVデバッグ画面

- 状況: 本番/現場運用でデバッグ情報が誤って表示される
- 期待: デバッグ画面と詳細表示は DEV のときのみ有効で、本番ビルドでは露出しない

デバッグ画面に出してよい情報（メタ情報のみ）:

- SSE接続の状態、直近エラー種別（例: "Network error"）
- 状態スナップショットの要約（mode/phase 等）
- tool calling の件数・ツール名（arguments や会話全文は表示しない）

シナリオ-6（テスト保守性）: セレクタが不安定

- 状況: 画面の文言/装飾が変わるたびにE2Eが壊れる
- 期待: テストは role/aria を優先し、KIOSK/STAFFの主要要素はセマンティクスを維持することで、見た目の変更に耐える

---

## 4. Issue分割案

### 4.1 Issue一覧

Issue-1
番号: 1
Issue名: UI基盤（トークン/フォント方針/ボタン状態/Reduced Motion）
概要: CSS変数導入、focus-visible、prefers-reduced-motion、ボタンのhover/active、フォント方針を反映する
推定行数: 150-250行
依存: -

Issue-2
番号: 2
Issue名: KIOSK リデザイン（背景/バッジ/録音/バブル/同意モーダル）
概要: KIOSKの見た目と誤操作防止を改善し、既存のセマンティクス（aria/data-testid）を維持する
推定行数: 200-300行
依存: #1

Issue-3
番号: 3
Issue名: STAFF リデザイン（ログイン/ステータス/セッション制御/緊急停止/pending）
概要: STAFFの操作性を上げ、緊急操作を分離・強調し、レスポンシブを改善する
推定行数: 200-300行
依存: #1

Issue-4
番号: 4
Issue名: DEVデバッグ画面（/debug）追加（別タブ集約）
概要: DEVのみ有効なデバッグ画面を追加し、KIOSK/STAFFのデバッグ表示（Stream/TTS/エラー/tool calling等）を集約する。表示内容はメタ情報に限定し、データ最小化を守る
推定行数: 150-250行
依存: #1

Issue-5
番号: 5
Issue名: 開発者向けラベル整理（DEVのみ表示）+ テスト更新
概要: KIOSK/STAFF本体から Stream/TTS等の技術ラベルを外し、DEV時は /debug へ誘導する。Vitest/Playwrightの期待値を更新する
推定行数: 100-200行
依存: #2, #3, #4

Issue-6
番号: 6
Issue名: Playwright スモーク強化（最小）
概要: /kiosk と /staff の主要要素（見出し/モーダル/ログイン/主要操作）を安定して検証できるよう調整する。原則として reduced-motion を強制し、アニメーション起因のフレークを抑える
推定行数: 80-150行
依存: #2, #3, #5

### 4.2 依存関係図

依存関係（関係を1行ずつ列挙）:

- Issue 2 depends_on Issue 1
- Issue 3 depends_on Issue 1
- Issue 4 depends_on Issue 1
- Issue 5 depends_on Issue 2
- Issue 5 depends_on Issue 3
- Issue 5 depends_on Issue 4
- Issue 6 depends_on Issue 2
- Issue 6 depends_on Issue 3
- Issue 6 depends_on Issue 5

---

## 5. プロダクション品質設計（PRD Q6に応じて記載）

### 5.1 パフォーマンス設計（PRD Q6-7: Yesの場合必須）

PRD Q6-7: No
N/A（パフォーマンス要件なし）

補足:

- `backdrop-filter` やアニメーションは端末によって重くなる可能性があるため、reduced motion とフォールバックを用意する

### 5.2 セキュリティ設計（PRD Q6-5: Yesの場合必須）

PRD Q6-5: Yes

扱うデータ:

- 表示文言（KIOSK/STAFFのエラー/ステータス）: 個人情報や会話全文を含めない（既存方針の維持）

認証/認可:

- 既存のSTAFFアクセス制御を前提とし、本Epicでは変更しない

対策チェックリスト:

- [ ] 外部通信を増やさない（特に外部フォント/CDN依存を避ける）
- [ ] 技術情報（内部URL/プロバイダ名等）を本番UIに出さない
- [ ] DEVデバッグ画面の表示は DEV のときのみに限定し、本番ビルドで露出しない
- [ ] 表示文字列のエスケープを前提とし、危険なHTML挿入をしない

### 5.3 観測性設計（PRD Q6-6: Yesの場合必須）

PRD Q6-6: No
N/A（監査ログ要件なし。UI改善ではログ追加をしない）

### 5.4 可用性設計（PRD Q6-8: Yesの場合必須）

PRD Q6-8: No
N/A（可用性要件なし）

---

## 6. リスクと対策

リスク-1
リスク: UI変更で既存テストが壊れる/フレークする
影響度: 中
対策: aria/role中心のセレクタ維持、reduced-motion、待機条件の見直し、段階的適用

リスク-2
リスク: 外部フォント等で運用が不安定になる
影響度: 中
対策: 外部CDN依存を避け、同梱またはシステムフォントに寄せる

---

## 7. マイルストーン

Phase-1
フェーズ: Phase 1
完了条件: トークン/ボタン状態/アクセシビリティ/Reduced Motion の土台が入り、既存テストがパスする
目標日: -

Phase-2
フェーズ: Phase 2
完了条件: KIOSK/STAFF の見た目と操作性が改善され、Playwrightスモークが安定してパスする
目標日: -

---

## 8. 技術方針別の制限チェック

### シンプル優先の場合

- [x] 外部サービス数が1以下
- [x] 新規導入ライブラリが3以下
- [x] 新規コンポーネント数が3以下
- [x] 非同期基盤（キュー/イベントストリーム）を使用していない
- [x] マイクロサービス分割をしていない
- [x] コンテナオーケストレーション（K8s等）を使用していない

### 共通チェック

- [x] 新規技術/サービス名が5つ以下
- [x] 各選択に「なぜこれを選んだか」の理由がある
- [x] 代替案（よりシンプルな方法）が提示されている
- [x] 「将来のため」だけを理由にした項目がない
- [x] 必須提出物（外部サービス一覧/コンポーネント一覧/新規技術一覧）が揃っている

---

## 9. Unknown項目の確認（PRDから引き継ぎ）

なし（PRD Q6 の Unknown は 0 件）

---

## 変更履歴

- 2026-02-06: v1.0 初版作成
- 2026-02-27: v1.1 全Issue完了確認（#106-#111）、ステータスを Completed に変更
