# Research (Estimation): issue-130

> この成果物は `/research estimation 130` の事前調査として作成。
> 保存先: `docs/research/estimation/issue-130/2026-02-24.md`

---

## メタ情報

- 作成日: 2026-02-24
- 作成者: OpenCode
- 対象: 見積もり前調査
- Issue: #130 feat(server): 低遅延音声パイプライン Phase3（LLM stream + 逐次セグメント送出）

---

## 1. 調査の目的

Issue #130 の Full見積もり前に、stream API追加時の実装面・検証面・失敗時の安全性要件を明確化し、工数レンジと信頼度の根拠を作る。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD/Epic/Issue に Unknown/曖昧さが残る: No
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: Yes

---

## 3. 候補（必須: >= 5）

候補-1
概要: `Providers["llm"]["chat"]` に `stream`（AsyncIterable）を追加し、`call` 互換を維持する。
適用可否: Yes
仮説: 既存 `call` 契約を壊さずに `stream` を併設すれば、段階導入と後方互換を両立できる。
反証: 既存呼び出し側・テストが `chat` の型変更で広範に破壊される場合。
採否理由: AC1 が「既存 call 維持」を明示しており、型拡張が最小変更で要件に一致するため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/130
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/providers/types.ts
捨て条件:
- 変更後に `chat.call` 既存パスで型エラー/挙動差分が多数発生する
リスク/検証:
- リスク: provider 実装（stub/local/external/gemini_native）全系統への波及
- 検証方法: `server/src/providers/llm-provider.test.ts` へ stream 非対応時の互換テストを追加

候補-2
概要: Effect Executor の `CALL_CHAT` で `stream` が利用可能なら逐次 `speech.segment` を送出し、最終確定は `CHAT_RESULT` を維持する。
適用可否: Yes
仮説: 現行のイベント非同期パターン（`then/catch -> enqueueEvent`）を流用すれば安全に導入できる。
反証: stream処理で例外時の `CHAT_FAILED` 連携や最終 `CHAT_RESULT` の整合が崩れる場合。
採否理由: AC2/AC3 の中核であり、既存の `CALL_CHAT` 失敗フォールバック実装と整合するため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/effect-executor.ts
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/effect-executor.test.ts
捨て条件:
- `CHAT_RESULT` が欠落または二重発火し Orchestrator の状態遷移を破壊する
リスク/検証:
- リスク: stream途中失敗時の会話停止
- 検証方法: streamエラー注入テストで `CHAT_FAILED` or `safe fallback` を保証

候補-3
概要: 文境界分割は既存 `splitSpeechSegments` を再利用し、delta蓄積 -> 文完成時のみ送出する。
適用可否: Partial
仮説: 既存分割ロジックが句読点境界の基礎要件を満たし、stream deltaにも適用できる。
反証: delta途中断片で短文抑制ロジックが過剰結合し、早出し遅延や誤分割が増える場合。
採否理由: 再利用価値は高いが、stream向けには「未確定バッファ管理」が追加で必要なため Partial。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/effect-executor.ts
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-ai-voice-latency-epic.md
捨て条件:
- 文境界検出が TTFA 目標を阻害する（早出しが実質機能しない）
リスク/検証:
- リスク: 断片過多または出力遅延
- 検証方法: segment件数・first segment 時刻を既存メトリクスで比較

候補-4
概要: stream失敗時に非stream `call` へ安全フォールバック（会話継続優先）を用意する。
適用可否: Yes
仮説: provider通信不安定時に `call` フォールバックを明示すれば AC3 を満たせる。
反証: フォールバックで重複発話/二重課金相当の呼び出し副作用が発生する場合。
採否理由: PRDの異常系方針（会話停止回避）と一致し、失敗時挙動を deterministic にできるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/prd/wooly-fluffy.md
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/orchestrator.ts
捨て条件:
- provider仕様上、失敗後の再実行が副作用を許容できない
リスク/検証:
- リスク: 応答遅延増加・テキスト不一致
- 検証方法: stream失敗時の代替経路テストを追加し、会話継続のみ保証

候補-5
概要: TTFA評価可能性のため、既存 `speech.ttfa.observation` 指標を stream経路でも維持する。
適用可否: Yes
仮説: 最初の `speech.segment` 送出時点計測を維持すれば Phase3 比較が可能。
反証: stream経路で観測点が不一致になり、ベースライン比較不能になる場合。
採否理由: AC4 の評価可能性要件に直結し、既存観測モデルを拡張利用できるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-ai-voice-latency-epic.md
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/http-server.ts
捨て条件:
- 計測値が stream導入前後で定義不一致になる
リスク/検証:
- リスク: 指標が評価用途に使えない
- 検証方法: テストで観測イベントの `emitted_at_ms/segment_count` を確認

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: OpenAI互換のchat streaming（delta逐次受信）
根拠リンク:
- https://platform.openai.com/docs/guides/streaming-responses

隣接領域-2
概要: Gemini API の streaming / generateContent 周辺仕様
根拠リンク:
- https://ai.google.dev/gemini-api/docs/text-generation

抽象化-1
原理/パターン: 「最終確定イベント」と「途中経過イベント」を分離し、状態遷移は最終確定だけで更新する

抽象化-2
原理/パターン: incremental buffer + sentence boundary flush

抽象化-3
原理/パターン: fail-open for UX continuity（失敗時でも会話停止を回避）

適用マッピング
- PRD: FR-7, AC-5, AC-E5 の実現経路を具体化
- Epic: Issue-3（#130）の stream導入方針と整合
- Estimation: provider型拡張・effect-executor・テスト追加の工数レンジを狭める

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- 実装候補を 5 件以上で比較し、採否理由と捨て条件を明示できた
- Full見積もりの不確実性（技術/検証）を section 3/9 に落とし込める状態になった

---

## 6. 探索ログ（必須）

- 何を調べたか: Issue #130、Epic Issue-3、PRD FR-7/AC-5/AC-E5、`effect-executor` と provider 型/実装、既存テストの非同期失敗時パターン
- 何を除外したか: DB変更・永続化仕様変更（本Issueのスコープ外）、KIOSK再生アルゴリズム改修（#129 側責務）
- 未解決: providerごとの stream イベントフォーマット差分（OpenAI互換/Gemini）をどこまで共通化するか

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: stream失敗時のフォールバック整合、最終 `CHAT_RESULT` と早出しイベントの二重管理
- 調査で減った不確実性: 変更中心が provider型 + effect executor + tests に収束し、DB/I/O拡張不要が確定
- テスト計画への影響: stream成功・途中失敗・フォールバック・順序保証・TTFA観測を最小セットとして追加
