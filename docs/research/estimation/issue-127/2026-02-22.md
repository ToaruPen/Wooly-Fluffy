# Research (Estimation): issue-127

---

## メタ情報

- 作成日: 2026-02-22
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #127 test(quality): セッション要約移行後のテスト改修（web中心）

---

## 1. 調査の目的

Issue #127 の見積もり前に、session summaries 移行後の回帰点（list/confirm/deny/SSE）を web 側テストでどの粒度に再編するかを確定し、旧設計依存（Mode/PERSONAL/consent）テストの整理方針と品質ゲート実行コストを明確化する。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: Yes

---

## 3. 候補（必須: >= 5）

候補-1
概要: `web/src/app.test.tsx` の巨大テストを責務別 describe に再編し、session summaries 回帰点を独立テストへ切り出す
適用可否: Yes
仮説: 認証/一覧/confirm/deny/SSE更新を分割すると失敗原因がテスト名で即時特定できる
反証: 切り出し後に共通セットアップが重複し、可読性や保守性がむしろ低下する
採否理由: AC2/AC4 に直結し、現状の単一巨大ファイル由来の追跡困難を解消できるため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/127
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/app.test.tsx
捨て条件:
- 既存テスト構造を維持するプロジェクト方針に変更された場合
リスク/検証:
- リスク: モック初期化漏れによる flaky 化
- 検証方法: describe 単位で setup/teardown を局所化し `npm run test` を複数回実行

候補-2
概要: `server/src/http-server.test.ts` で staff session summaries API と SSE の契約境界を補強する
適用可否: Partial
仮説: web 側だけでなく server 契約テストも補強すると、UI回帰の真因分離（UI不具合かAPI契約破壊か）が容易になる
反証: #127 のスコープ（web中心）を超えて工数が膨らみ、見積もり精度が下がる
採否理由: 品質ゲートとして有効だが、最小限の追加に限定する前提で Partial 採用が妥当
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/http-server.test.ts
捨て条件:
- web 側で契約差分を十分に検知できると判断できた場合
リスク/検証:
- リスク: 重複検証でテスト実行時間が過度に増加
- 検証方法: coverage レポートと失敗時ログ粒度を比較し追加価値を確認

候補-3
概要: 旧設計依存（Mode/PERSONAL/consent 前提）アサーションを除去し、session summary 前提の期待値へ置換する
適用可否: Yes
仮説: 不要な mode 表示前提や legacy event 前提を除くことで、移行後仕様との不整合失敗を解消できる
反証: 旧仕様に依存する安全要件まで誤って削除してしまう
採否理由: AC3 の主目的であり、現在 `app.test.tsx` に mode/PERSONAL 由来の期待が多数残っているため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/127
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/app.test.tsx
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/http-server.llm-async.test.ts
捨て条件:
- PRD/Epic 側で mode 再導入が明示された場合
リスク/検証:
- リスク: 仕様上必要な表示まで削除する過剰整理
- 検証方法: PRD/Epic の AC と 1:1 でテスト TODO を対応付けレビュー

候補-4
概要: pending 一覧/confirm/deny の失敗系（401/500/network）を UI レイヤで責務別に固定する
適用可否: Yes
仮説: 正常系と異常系を分離すると、障害時の追跡性が上がり AC4 を満たせる
反証: 失敗パターンを過剰に細分化してメンテ負荷が増える
採否理由: 既に app.test に断片的に存在するため、再編中心で実装コストに対し効果が高い
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/app.test.tsx
捨て条件:
- エラーハンドリング方針が別Issueで大幅変更される場合
リスク/検証:
- リスク: エラーメッセージ文言変更で脆いテストになる
- 検証方法: 文言全文一致ではなく役割ベース（再ログイン促し/再試行導線）で検証

候補-5
概要: テストユーティリティ（SSEモック/HTTPモック）を共有化して重複を削減する
適用可否: Partial
仮説: 最小限の helper 化で責務別ファイル化してもテスト記述量を抑えられる
反証: helper 抽象化が進みすぎてテスト意図が見えにくくなる
採否理由: 再編の副作用（重複増）を抑えるため有効だが、過抽象化を避けるため Partial 採用
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/app.test.tsx
捨て条件:
- 小規模分割で重複が実害にならない場合
リスク/検証:
- リスク: helper 変更時に広範囲へ影響
- 検証方法: helper は pure function 中心にし、import 先を限定

候補-6
概要: `npm run test` / `npm run coverage` をゲートとして最後に一括実行し、閾値維持を確認する
適用可否: Yes
仮説: 最終ゲートを明示すると AC1 を完了判定に直接接続できる
反証: coverage 実行時間が長く、修正ループでの実用性が低い
採否理由: Issue AC1 そのものであり、品質ゲートとして必須
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/127
捨て条件:
- CIコマンド名が変更された場合
リスク/検証:
- リスク: ローカル環境差異で偽失敗
- 検証方法: ワークスペース固定コマンドを使用し、失敗時はログを証跡化

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域探索: N/A（既存 web/server テスト資産の再編が主であり、新規技術導入はない）

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- AC1〜AC4 をテスト TODO に分解し、変更対象ファイルを特定できている
- 追加テストと整理テストの境界（何を増やし、何を削るか）が明文化されている

---

## 6. 探索ログ（必須）

- 何を調べたか: `gh issue view 127`, `docs/prd/wooly-fluffy.md`, `docs/epics/wooly-fluffy-mvp-epic.md`, `web/src/app.test.tsx`, `web/src/kiosk-page.local-ptt.test.tsx`, `server/src/http-server.test.ts`, `server/src/http-server.llm-async.test.ts`
- 何を除外したか: 本番コードの仕様変更（server/web本体ロジック）、DBマイグレーション、新規外部依存導入（いずれもIssue #127 のスコープ外）
- 未解決: `blocked` ラベル起因の前提（#119/#123 完了後の固定化時点）で期待値微調整が必要になる可能性

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: `web/src/app.test.tsx` の巨大ファイル再編で、分割単位を誤ると工数が増える
- 調査で減った不確実性: session summaries 回帰点は既存テスト断片が存在し、完全新規より「整理+補強」中心で進められる
- テスト計画への影響: AC2/AC3/AC4 を「一覧」「confirm/deny」「SSE同期」「legacy依存除去」の4責務に分解し、最後に `npm run test` / `npm run coverage` をゲート実行する
