# Research (Estimation): issue-125

---

## メタ情報

- 作成日: 2026-02-22
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #125 deps: chokidar/yaml/valibot 導入（persona/policy 外部注入 + 出力長制限用）

---

## 1. 調査の目的

Issue #125 の見積もり前に、依存追加の実作業範囲（server ワークスペース限定）、既存依存との整合、品質ゲート（typecheck/test）への影響、および prereq としての完了条件を明確化し、工数レンジと信頼度を安定化する。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD/Epic/Issue に Unknown/曖昧さが残る: No
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: Yes

---

## 3. 候補（必須: >= 5）

候補-1
概要: `server/package.json` に `chokidar`/`yaml`/`valibot` を dependencies として追加済みか確認し、未反映なら同時に追加する
適用可否: Yes
仮説: 依存宣言を server ワークスペースに限定すれば、Issue のスコープを守りつつ #124 の前提を満たせる
反証: 依存が root や他 workspace に誤って追加されると、意図しない影響とレビュー差分増大が発生する
採否理由: Issue 本文の受け入れ条件と「serverワークスペース限定」に直接一致するため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/125
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/package.json
捨て条件:
- 依存が既に main へ反映済みであり、追加変更が不要と確認できた場合
リスク/検証:
- リスク: 依存の追加先ミス（root/別workspace）
- 検証方法: `server/package.json` と `git diff -- server/package.json` の確認

候補-2
概要: lockfile 更新の必要有無を判定し、必要なら `npm install` を実行して再現可能な依存解決状態を固定する
適用可否: Yes
仮説: package 管理の実体（lockfile）を伴わない依存宣言変更は CI で解決差分を誘発しやすい
反証: リポジトリ運用上 lockfile を更新しない方針である場合、追加更新は不要
採否理由: AC に `npm install` 後の typecheck/test が含まれ、依存解決の再現性担保が必要なため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/125
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/README.md
捨て条件:
- lockfile が本リポジトリで運用対象外で、CI も lockfile 依存でないと明示されている場合
リスク/検証:
- リスク: lockfile 不整合で CI/ローカル差異が発生
- 検証方法: `npm install` 実行後に差分と `npm run -w server typecheck` を確認

候補-3
概要: 依存追加のみで runtime 挙動が変わらないことをテスト結果で確認する（実装コードは増やさない）
適用可否: Yes
仮説: 依存追加だけなら既存テストが同等に通過し、挙動差分なしを証明できる
反証: transitive dependency 更新で既存テストが不安定化する場合、実装変更なしでも挙動差分が発生しうる
採否理由: Issue の AC に「依存導入だけで挙動変更が出ない」が明記されているため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/125
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/package.json
捨て条件:
- テストが恒常的に不安定で、依存追加有無と切り分けできない場合
リスク/検証:
- リスク: 既存不安定テストにより誤検知
- 検証方法: `npm run -w server test` の再実行と差分比較

候補-4
概要: 依存導入理由・ライセンス一次情報リンクを Issue 記録として維持し、追加ドキュメント変更は最小にする
適用可否: Yes
仮説: 既に Issue 本文に理由/ライセンス URL があり、追加資料なしでトレーサビリティ要件を満たせる
反証: レポジトリ規約で CHANGELOG/ADR 更新が必須となる場合、Issue 本文のみでは不足する
採否理由: Issue スコープが依存追加に限定され、理由/リンクが既に本文に揃っているため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/125
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/decisions.md
捨て条件:
- 監査手順上、Issue 本文だけでは不十分で別ファイル記録が必須な場合
リスク/検証:
- リスク: 記録場所の認識違いでレビュー差し戻し
- 検証方法: Issue 本文の該当節と repo 既存慣例を照合

候補-5
概要: #124 の prereq として #125 完了条件を明文化し、見積もりを前提管理する
適用可否: Yes
仮説: prereq の完了条件（依存存在 + server typecheck/test pass）を固定すると #124 側見積もりの不確実性を下げられる
反証: #124 が依存を実際には使わない実装へ変更された場合、prereq 制約が過剰になる
採否理由: #124 見積もり資料に #125 前提が既に記載されており、整合が必要なため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/124
- https://github.com/ToaruPen/Wooly-Fluffy/issues/125
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/research/estimation/issue-124/full-estimate-2026-02-22.md
捨て条件:
- #124 が独立実装へ方針変更され、#125 依存が削除された場合
リスク/検証:
- リスク: 前提ずれで着手順序が混乱
- 検証方法: `gh issue view 124`/`gh issue view 125` で依存記載を照合

候補-6
概要: 依存追加対象を 3 パッケージに固定し、追加要求は別 Issue に分離する
適用可否: Yes
仮説: 依存導入を最小セットに固定すると、工数レンジとレビュー範囲を安定化できる
反証: 実装時に補助依存（例: 型補助）が必須と判明し、同 Issue 内で追加せざるを得ない
採否理由: Issue の Constraints に「依存は上記3つに限定」が明記されているため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/125
捨て条件:
- セキュリティ/ビルド上の blocker 回避として追加依存が必須と証明された場合
リスク/検証:
- リスク: スコープ逸脱による差分肥大
- 検証方法: 変更差分に 3 依存以外が含まれないことを `git diff` で確認

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域探索: N/A（依存追加 + 品質確認の範囲で、新規アーキテクチャ導入はない）

---

## 5. 止め時（必須）

タイムボックス: 45min
打ち切り条件:
- 変更対象（`server/package.json` と必要時 lockfile）が確定している
- AC の検証手順（`npm run -w server typecheck` / `npm run -w server test`）が明確化されている

---

## 6. 探索ログ（必須）

- 何を調べたか: `gh issue view 125`, `gh issue view 124`, `docs/prd/wooly-fluffy.md`, `docs/epics/provider-layer-epic.md`, `docs/research/estimation/issue-124/full-estimate-2026-02-22.md`, `server/package.json`
- 何を除外したか: web 側 UI 変更、DB マイグレーション、provider 実装本体（#124で扱う）
- 未解決: なし

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: lockfile 運用差・依存追加済み状態との整合確認
- 調査で減った不確実性: 変更対象が server 依存宣言と品質確認に限定される点を確定
- テスト計画への影響: server workspace の `typecheck`/`test` を最低ラインとして固定できる
