# Research (Estimation): issue-119

---

## メタ情報

- 作成日: 2026-02-21
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #119 web(staff): セッション要約pending表示 + Mode表示削除

---

## 1. 調査の目的

Issue #119 の見積もり精度を上げるために、現行の STAFF UI 実装と #118 で確定した API/SSE 契約との差分を明確化し、変更行数・テスト範囲・リスクを事前確定する。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD/Epic/Issue に Unknown/曖昧さが残る: No
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: Yes

---

## 3. 候補（必須: >= 5）

候補-1
概要: `staff-page.tsx` の pending DTO を session summary DTO に差し替える
適用可否: Yes
仮説: `PendingItem` を `id/title/summary_json/status/created_at_ms/expires_at_ms` へ置換すれば #118 契約と整合する
反証: 画面表示に `personal_name/kind/value` 依存が残り、型エラーまたはランタイム表示崩れが発生する
採否理由: AC2/AC3 の最短経路で、変更箇所が UI 1ファイルに集中するため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/119
- https://github.com/ToaruPen/Wooly-Fluffy/issues/118
捨て条件:
- API契約が issue #118 以降で再変更されている場合
リスク/検証:
- リスク: `summary_json` 表示方針が曖昧
- 検証方法: 最低限はタイトル/要約/作成時刻/期限をDOMアサートで固定

候補-2
概要: STAFF API パスを `/api/v1/staff/session-summaries/*` へ移行する
適用可否: Yes
仮説: 一覧取得・Confirm・Deny の3経路を新パスへ統一すれば AC3 が充足される
反証: 旧 `/api/v1/staff/pending*` 前提の fetch モックが崩れ、既存テストが多数失敗する
採否理由: 受け入れ条件と Epic API設計に明示されており、回避不可
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/119
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-mvp-epic.md
捨て条件:
- 旧エンドポイント互換を本Issueで維持する指示が出た場合
リスク/検証:
- リスク: パス変更の取りこぼし
- 検証方法: `app.test.tsx` の staff系 fetch URL 期待値を全置換し、テストで検知

候補-3
概要: SSEイベント名を `staff.pending_list` から `staff.session_summaries_pending_list` に更新する
適用可否: Yes
仮説: onMessage の分岐条件を新イベント名に合わせれば AC4 の自動反映が成立する
反証: スナップショットのみ更新され、pending list push 更新が UI に反映されない
採否理由: #118 側で配信イベントが新名称へ移行済みであり、UI追随が必要
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/118
捨て条件:
- server側イベント名が旧名へ巻き戻されている場合
リスク/検証:
- リスク: 旧イベント名をテストが参照し続ける
- 検証方法: `handlers.onMessage` 入力を新イベント名に差し替えた上で一覧更新を検証

候補-4
概要: Modeカードを完全削除し、Phase/Pendingカードのみ残す
適用可否: Yes
仮説: `Mode` 依存コードと表示文言を削除しても Staff運用機能（PTT/緊急停止/レビュー）は維持される
反証: モード依存の表示ロジックが他UI（デバッグ等）に副作用を及ぼしテストが崩れる
採否理由: AC1 に直接対応し、UI契約を固定できるため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/119
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/prd/wooly-fluffy.md
捨て条件:
- PRD/Epicで STAFF に Mode 表示復活が指示された場合
リスク/検証:
- リスク: 既存テストが `Mode:` 文言を前提
- 検証方法: DOM期待値を `Mode` 非表示前提へ更新し、関連ケースを整理

候補-5
概要: staffテストを `web/src/app.test.tsx` に集約して最小差分で更新する
適用可否: Partial
仮説: 既存の staff auth/pending flows セクションを修正すれば、別テストファイル追加なしで AC 回帰を担保できる
反証: 単一ファイルが巨大化して可読性・保守性が悪化し、変更レビューが困難になる
採否理由: 今回は Issue スコープを守るため Partial 採用。分割は別Issue候補として扱う
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/app.test.tsx
捨て条件:
- テスト変更量が想定を超えて 300行を超える場合
リスク/検証:
- リスク: テスト意図の追跡性低下
- 検証方法: describe ブロック単位で AC 対応コメントを残し、期待値を最小限更新

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域探索: N/A（本Issueは既存 STAFF UI と #118 契約への追随であり、新規技術導入はない）

---

## 5. 止め時（必須）

タイムボックス: 45min
打ち切り条件:
- UI/テストの主変更点（DTO・APIパス・SSEイベント・Mode削除）が列挙できる
- 見積もりレンジに必要な不確実性が Med 以下まで下がる

---

## 6. 探索ログ（必須）

- 何を調べたか: `gh issue view 119`, `gh issue view 118`, `docs/prd/wooly-fluffy.md`, `docs/epics/wooly-fluffy-mvp-epic.md`, `web/src/staff-page.tsx`, `web/src/app.test.tsx`
- 何を除外したか: サーバ実装修正（Issue #119 のスコープ外）、DB変更（Issue #115/#118 で対応済み）
- 未解決: `summary_json` の表示フォーマット（プレーン文字列化かキー展開か）は実装時に既存UI基準で最小決定が必要

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: 既存 `app.test.tsx` の staffケースが多く、URL/イベント名置換の波及が大きい
- 調査で減った不確実性: 変更中心は `web/src/staff-page.tsx` と `web/src/app.test.tsx` に限定可能
- テスト計画への影響: AC1〜AC4 に対応する DOM 表示・mutation成功後更新・SSE反映テストを優先して更新する
