# Research (Estimation): issue-103

> このテンプレートは `/research estimation` コマンドで使用されます。
> 成果物は `docs/research/estimation/issue-<n>/<YYYY-MM-DD>.md` に保存します。

---

## メタ情報

- 作成日: 2026-02-20
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #103 feature: Codexレビュー監視をイベント駆動に移行

---

## 1. 調査の目的

Issue #103 の受け入れ条件（イベント駆動化、bot allowlist、一貫フォーマット通知、後方互換、fail-fast）を、既存の `scripts/agentic-sdd/watch-codex-review.sh` と整合した最小変更で実現するために、不確実性（イベントpayload差分、権限不足時挙動、通知フォーマット）を先に潰して見積もり幅を狭める。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: Yes
  - 補足: このリポジトリにはポーリング監視（`scripts/agentic-sdd/watch-codex-review.sh`）はあるが、PRレビュー系3イベントを横断して同一フォーマット通知する workflow 実装は未存在。
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
  - 補足: PRD Q6-3 が `Unknown`、かつ Issue では「必要に応じて複数bot」の境界が未確定。
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: No
  - 補足: PRD Q6-5〜8 はすべて No。

---

## 3. 候補（必須: >= 5）

候補-1
概要: `.github/workflows/codex-review-events.yml` を新規追加し、`issue_comment` / `pull_request_review` / `pull_request_review_comment` の3イベントを明示登録する
適用可否: Yes
仮説: トリガーを明示列挙すれば AC1 を最小構成で満たせる
反証: workflow 起動はするがいずれかのイベントで PR番号抽出ができず通知不能になる
採否理由: AC1 の中心要件であり、既存 workflow への影響を最小化できる
根拠リンク:
- https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows
- https://github.com/ToaruPen/Agentic-SDD/issues/103
- scripts/agentic-sdd/watch-codex-review.sh
捨て条件:
- 既存 CI の設計都合で単独 workflow 追加が禁止される場合
リスク/検証:
- リスク: イベントごとに payload 形が異なり統一処理が崩れる
- 検証方法: `if:` 条件と `jq`/Python 抽出ロジックをイベント別fixtureで確認

候補-2
概要: bot 判定を allowlist 変数（例: `CODEX_BOT_LOGINS`）で行い、対象外は成功終了(no-op)する
適用可否: Yes
仮説: `sender.login` を allowlist 照合すれば AC2 を fail-safe に満たせる
反証: bot名の揺れや将来追加時に workflow 変更なしでは運用不能になる
採否理由: 現行スクリプトでも同名環境変数を採用しており運用モデルを揃えられる
根拠リンク:
- scripts/agentic-sdd/watch-codex-review.sh
- https://github.com/ToaruPen/Agentic-SDD/issues/103
- README.md
捨て条件:
- リポジトリ方針で環境変数による allowlist を避ける決定がある場合
リスク/検証:
- リスク: 未設定時に意図しない全許可/全拒否になる
- 検証方法: 未設定時デフォルトを `chatgpt-codex-connector[bot]` に固定し、対象外は no-op で終了することをログで確認

候補-3
概要: 通知フォーマットを共通テンプレート（PR番号、URL、種別、本文抜粋）で1か所生成する
適用可否: Yes
仮説: 共通化すれば AC3 の「一貫フォーマット」を低コストで維持できる
反証: イベント差で参照可能フィールドが異なり、テンプレート側で分岐が過剰化する
採否理由: 仕様変更時の更新点を1か所に集約でき、テスト観点も単純化できる
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/103
- .agent/commands/codex-pr-review.md
- scripts/agentic-sdd/watch-codex-review.sh
捨て条件:
- 3イベントで必要情報の取得経路が全く共有できない場合
リスク/検証:
- リスク: 本文抜粋の長さ制御で可読性が落ちる
- 検証方法: 120文字程度の上限で切り詰め、改行除去後の出力例を snapshot 比較

候補-4
概要: `README.md` に「イベント駆動推奨、ポーリングfallback」を明記し既存 `scripts/agentic-sdd/watch-codex-review.sh` は維持する
適用可否: Yes
仮説: ドキュメント更新のみで AC4 を満たしつつ既存利用者の運用を壊さない
反証: イベント駆動 workflow に必須前提（例: secrets/権限）が多く、推奨文言だけでは誤運用が多発する
採否理由: 互換性と移行誘導の両立が可能
根拠リンク:
- README.md
- scripts/agentic-sdd/watch-codex-review.sh
- https://github.com/ToaruPen/Agentic-SDD/issues/103
捨て条件:
- 互換維持ではなく即時廃止が方針決定される場合
リスク/検証:
- リスク: fallback の意味が曖昧でユーザーが選択できない
- 検証方法: README に利用シナリオ（通常=イベント駆動、ローカル即時監視=ポーリング）を明記

候補-5
概要: 認証/権限不足を fail-fast で検出し、原因と次アクションをエラーメッセージで返す
適用可否: Yes
仮説: 事前に `gh auth status` や API 呼び出し失敗を検出すれば AC5 を満たせる
反証: Actions 実行環境では `gh` より `GITHUB_TOKEN` API 呼び出しが主で、同じ失敗文言を統一できない
採否理由: 運用トラブル時の初動短縮に直結し、Issue で明示された fail-fast 要件に合致
根拠リンク:
- scripts/agentic-sdd/watch-codex-review.sh
- https://github.com/ToaruPen/Agentic-SDD/issues/103
- https://docs.github.com/en/actions/security-guides/automatic-token-authentication
捨て条件:
- 権限不足を黙ってskipする運用方針に変更される場合
リスク/検証:
- リスク: 失敗時に情報不足で再現不能になる
- 検証方法: 403/401/Not Found の代表パターンでエラー文面を固定し、原因・影響・次手順を含める

候補-6
概要: PR由来の `issue_comment` のみ処理し、通常 Issue コメントは no-op にする
適用可否: Partial
仮説: `github.event.issue.pull_request` の存在確認で誤起動を抑制できる
反証: 将来「Issue上のbot通知も対象」に拡張したい要求が出る
採否理由: 現Issueの文脈は PRレビュー監視であり、誤通知防止を優先する
根拠リンク:
- https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows
- https://github.com/ToaruPen/Agentic-SDD/issues/103
捨て条件:
- 仕様として通常 Issue も対象に含める合意が得られた場合
リスク/検証:
- リスク: 条件判定漏れで通常 Issue でも通知が発火する
- 検証方法: `issue_comment` payload の PR有無2ケースで分岐テストを実施

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: GitHub Actions のイベントフィルタ（`types`/`if`）設計を確認し、最小トリガー + 条件分岐で no-op を実現する。
根拠リンク:
- https://docs.github.com/en/actions/reference/workflows-and-actions/events-that-trigger-workflows
- https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions

隣接領域-2
概要: Botアカウントの絞り込みを allowlist で管理する運用を確認し、将来bot追加時の変更点を環境変数に閉じ込める。
根拠リンク:
- scripts/agentic-sdd/watch-codex-review.sh
- README.md

抽象化-1
原理/パターン: イベント駆動移行では「入口は広く、実行条件は狭く（deny-by-default）」を徹底する。

抽象化-2
原理/パターン: フォーマット統一は抽出レイヤーより表示レイヤーを先に共通化し、差分は入力正規化で吸収する。

抽象化-3
原理/パターン: 後方互換は削除ではなく推奨順位の明示で移行させ、fallbackの責務を文書化する。

適用マッピング
- PRD: `docs/prd/agentic-sdd-harness-engineering.md` の fail-fast / 互換維持方針に一致
- Epic: `docs/epics/agentic-sdd-harness-engineering.md` の「オーケストレーション本体は作らない、最小雛形」方針に一致
- Estimation: #103 の工数は workflow追加 + 文書改訂 + 既存スクリプト最小調整の3塊で見積もる

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- AC1〜AC5を1対1で実装要素へマッピングできた
- 不確実性を「イベントpayload差異」「権限不足時挙動」「bot追加運用」の3点に絞り込めた

---

## 6. 探索ログ（必須）

- 何を調べたか: `gh issue view 103`、`scripts/agentic-sdd/watch-codex-review.sh`、`README.md`、`.agent/commands/codex-pr-review.md`、GitHub Docs（Actions events / token auth）
- 何を除外したか: 新規の外部SaaS通知（Slack/Discord）連携（Issue要求外）、大規模な自動修正オーケストレーション（Epicスコープ外）
- 未解決: allowlist の既定値を workflow 側でも `chatgpt-codex-connector[bot]` 単独に固定するか、READMEで複数例を既定として示すか

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: イベントごとの payload 差異、`issue_comment` の PR判定漏れ、権限不足時の文面統一
- 調査で減った不確実性: 変更対象は workflow/README/既存スクリプト周辺に閉じ、ACと実装要素の対応を確定できた
- テスト計画への影響: shellテスト or ローカル検証手順で「対象botのみ実行」「対象外no-op」「権限不足fail-fast」「フォーマット統一」を観測する必要がある
