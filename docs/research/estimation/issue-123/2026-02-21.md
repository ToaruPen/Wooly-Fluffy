# Research (Estimation): issue-123

---

## メタ情報

- 作成日: 2026-02-21
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #123 cleanup: legacy PERSONAL/memory/consent artifacts removal (post session-summary MVP)

---

## 1. 調査の目的

Issue #123 の見積もり前に、旧設計（PERSONAL/consent/memory_items）由来の削除対象を server/web/test/env で特定し、削除時の破壊範囲と検証ポイントを明確化する。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD/Epic/Issue に Unknown/曖昧さが残る: No
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: Yes

---

## 3. 候補（必須: >= 5）

候補-1
概要: `server/src/orchestrator.ts` の `Mode/PERSONAL/consent/memory_extract` 系分岐を削除し、ROOM一本へ単純化する
適用可否: Yes
仮説: `Mode` を廃止しても PRD/Epic（モード表示なし・ROOM一本）と整合し、状態遷移は縮退して安全になる
反証: `UI_CONSENT_BUTTON` や `STORE_WRITE_PENDING` 前提のイベント/Effect依存が残り、型エラーまたは主要テスト失敗が広範囲に発生する
採否理由: #123 の主目的そのもの。最も効果が大きく、分岐削減で将来保守コストを下げるため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/123
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/prd/wooly-fluffy.md
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-mvp-epic.md
捨て条件:
- #117/#118/#119 が main へ反映されておらず依存未解決の場合
リスク/検証:
- リスク: Orchestratorのイベント整合崩れ
- 検証方法: `server/src/orchestrator.test.ts` と `server/src/effect-executor.test.ts` の回帰テスト更新+実行

候補-2
概要: `server/src/store.ts` の `memory_items` DDL/CRUD を削除し、`session_summary_items` のみ残す
適用可否: Yes
仮説: 旧 pending(memory_items) の参照経路を断てば、DB構造が現行仕様（session summary）に一本化される
反証: 旧API/旧テストが暗黙に `memory_items` を要求し、起動時やテスト時に失敗する
採否理由: 受け入れ条件「旧 API/DB経路の撤去」に必須で、仕様との乖離を直接解消できるため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/123
- https://github.com/ToaruPen/Wooly-Fluffy/issues/118
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-mvp-epic.md
捨て条件:
- 既存運用DBの自動DROPを必須にする要件が新規追加された場合（本Issueは自動破壊を避ける）
リスク/検証:
- リスク: 既存DBとの後方互換誤解
- 検証方法: 「新規DBで memory_items 非生成」をテストで固定し、README/運用手順に明記

候補-3
概要: `server/src/http-server.ts` から `UI_CONSENT_BUTTON` 入力・`WF_CONSENT_TIMEOUT_MS` を削除する
適用可否: Yes
仮説: consent UI と timeout は旧設計専用のため、削除しても現行セッション要約フローには不要
反証: KIOSK/STAFF から consent 依存イベントが残り、HTTP route と UI が不整合になる
採否理由: 環境変数/HTTP契約の負債を減らし、誤設定ポイントを削減できるため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/123
- https://github.com/ToaruPen/Wooly-Fluffy/issues/119
捨て条件:
- consent フロー再導入が新Epicで決定された場合
リスク/検証:
- リスク: 未更新クライアントが旧イベントを送信
- 検証方法: `server/src/http-server.test.ts` の旧 consent ケースを撤去/置換し、invalid event の扱いを確認

候補-4
概要: `web/src/kiosk-page.tsx` と `web/src/debug-page.tsx` から Mode/consent 表示を除去する
適用可否: Yes
仮説: UIから旧概念を消すことで、現場操作の誤解を防ぎ仕様認知負債を減らせる
反証: debug/staff テストで mode前提アサートが残り、画面・テスト双方が破綻する
採否理由: #123 AC（Mode/consent/旧pending UI撤去）に直結し、利用者混乱を抑えられるため
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/123
- https://github.com/ToaruPen/Wooly-Fluffy/issues/119
捨て条件:
- デバッグ用途として mode 表示継続の明示要件が追加された場合
リスク/検証:
- リスク: `web/src/app.test.tsx` の大量期待値更新漏れ
- 検証方法: app/staff/kiosk 系テストで「Mode文言なし」「consent UIなし」を回帰確認

候補-5
概要: `server/src/providers/llm-provider.ts` の inner_task `consent_decision/memory_extract` を撤去し `session_summary` 系のみに寄せる
適用可否: Yes
仮説: 旧 inner_task を削除すれば、LLM責務が現仕様に一致し、プロンプト/スキーマ負債を削減できる
反証: orchestrator/effect 側がまだ旧 task 名を送信し、実行時エラーやテスト不一致が発生する
採否理由: 旧設計ロジックの再流入を防ぐ境界として重要で、保守範囲の縮小効果が高い
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/123
- https://github.com/ToaruPen/Wooly-Fluffy/issues/117
捨て条件:
- 旧 task を互換維持する方針へ変更された場合
リスク/検証:
- リスク: モック/stub の更新漏れ
- 検証方法: `server/src/providers/llm-provider.test.ts` を中心に task enum 契約を再固定

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: Feature flag撤去やレガシー分岐除去の一般パターン（delete-first, contract-first）
根拠リンク:
- https://martinfowler.com/bliki/FeatureToggle.html

隣接領域-2
概要: データ最小化要件下でのログ/永続化面の回帰防止（privacy regression testing）
根拠リンク:
- https://owasp.org/www-project-top-ten/

抽象化-1
原理/パターン: 仕様で不要になった分岐は互換層を残さず削除し、契約を一本化する

抽象化-2
原理/パターン: DBは「新規作成時の正しい最小構造」をまず固定し、破壊的移行は明示手順で分離する

抽象化-3
原理/パターン: 旧仕様テストを削るだけでなく、新仕様の受け入れ条件に対応したテストへ置換する

適用マッピング
- PRD: FR-1/FR-3 と AC-1..4 の「ROOM一本 + session summary」の契約を維持し、旧概念再流入を防ぐ
- Epic: Issue #117/#118/#119 後の cleanup を「契約一本化フェーズ」として整理する
- Estimation: 破壊範囲を orchestrator/store/http/web/test に分割し、段階検証（typecheck/lint/test/build）を工数に反映する

---

## 5. 止め時（必須）

タイムボックス: 90-120min（初期90min、条件該当で最大120minまで延長）
打ち切り条件:
- 削除対象が server/web/tests/env で列挙でき、見積もりの主要不確実性が Med 以下に下がる
- 検証コマンド（typecheck/lint/test/build）まで事前に定義できる
- 延長条件: 90min時点で上記2条件のどちらか未達、または削除対象が5モジュール以上（orchestrator/store/http/llm-provider/web/test）に跨る場合は120minまで延長
- 分割条件: 120minでも未解決が2件以上残る場合は「server cleanup」「web cleanup」「tests cleanup」にバッチ分割して再見積もり

---

## 6. 探索ログ（必須）

- 何を調べたか: `gh issue view 123`, `gh issue view 117`, `gh issue view 118`, `gh issue view 119`, `docs/prd/wooly-fluffy.md`, `docs/epics/wooly-fluffy-mvp-epic.md`, `grep(PERSONAL|memory_items|consent)`
- 何を除外したか: 新規アーキテクチャ導入、依存追加、Issue #123 スコープ外の機能拡張
- 未解決: 既存DBの `memory_items` を自動DROPするかの運用方針（Issue文面では「原則しない」）

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: 削除対象が orchestrator/store/http/llm-provider/web/app.test にまたがり、テスト更新量が多い
- 調査で減った不確実性: 主対象ファイル群が明確化でき、削除要件は PRD/Epic と整合している
- テスト計画への影響: server/web の既存旧設計テストを現行フロー前提へ差し替え、データ最小化制約（本文/音声/STT全文非保存）の回帰確認を必須化
