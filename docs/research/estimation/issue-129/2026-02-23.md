# Issue #129 見積もり調査

- 対象Issue: #129
- 作成日: 2026-02-23
- 作成者: OpenCode

## 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD Q6 の Unknown 残件: No
- Q6-5（PII）/監査/性能/可用性のいずれかが Yes: Yes

## 候補評価

候補-1
概要: `speech.segment` 受信時に即再生せず、`segment_index` をキーに待機バッファへ蓄積し、次期待ち番号のみ再生する。
適用可否: Yes
仮説: バッファ+次期待ち番号で逆順到着でもFIFO再生を維持できる。
反証: 再生開始/終了の境界で待機番号がずれて重複再生または欠落が発生する。
採否理由: AC2の本丸要件であり、既存 `say_id` 重複抑止を置き換えずに段階導入できるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/129
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-ai-voice-latency-epic.md
捨て条件: `segment_index` 欠番時の待機戦略が複雑化し、実装が150-300行見積もりを大幅超過する場合は分割提案。
リスク/検証: out-of-order到着（2,0,1）の統合テストで再生順が0,1,2になることを確認する。

候補-2
概要: TTS取得は固定上限（2〜3）で並列実行し、in-flightと待機キューを分離管理する。
適用可否: Yes
仮説: 固定上限の並列化でTTFA短縮とブラウザ負荷の両立が可能。
反証: 並列取得で `/api/v1/kiosk/tts` 失敗率が上がり、体感改善よりエラー増が目立つ。
採否理由: AC1/AC4に直結し、EpicのPhase2目的（-20〜30%）と整合するため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/prd/wooly-fluffy.md
- https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API
捨て条件: 2並列でも待ち時間改善が観測できず、複雑度だけ増える場合は逐次取得に戻す。
リスク/検証: 並列上限1/2/3の比較ログでTTFA差分とエラー発生件数を評価する。

候補-3
概要: `stop_output` 受信時に再生中断だけでなく、待機バッファとin-flight結果の採用判定を世代IDで無効化する。
適用可否: Yes
仮説: 世代IDのインクリメントで遅延到着した古いTTS結果を確実に破棄できる。
反証: `stop_output` 後に古い結果がUIへ反映され、AC3/AC-E5に違反する。
採否理由: 既存の stale 無視ロジックを拡張するだけで要件達成可能で、設計方針（シンプル優先）に合う。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/kiosk-page.tsx
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/decisions/d-2026-02-20-ai-voice-low-latency-phased-rollout.md
捨て条件: 世代管理のみで未再生キューの掃除が不十分な場合は、明示的キャンセル構造を追加検討。
リスク/検証: stop_output直後に遅延レスポンスを返すテストで再生0件を固定する。

候補-4
概要: 既存 `kiosk.command.speak` 経路と `speech.segment` 経路を排他制御し、同一発話で混在再生させない。
適用可否: Yes
仮説: 経路分離を維持すれば回帰リスクを抑えつつPhase2を導入できる。
反証: 互換経路が同時に有効化されて二重音声再生が発生する。
採否理由: Issue本文の「混在させない」に直接対応し、影響範囲をKIOSK側に閉じられるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/129
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-ai-voice-latency-epic.md
捨て条件: 現行サーバが移行期間中に `speak` と `speech.segment` を併送する契約である場合は、サーバ側調整Issueを先行。
リスク/検証: 同一シナリオで `speak` のみ/`speech.segment` のみ/併送をモックし、重複再生が起きないことを確認する。

候補-5
概要: TTFA評価は本文を持たない計測（request/segment indexと時刻差）を最小限追加して比較可能性を確保する。
適用可否: Partial
仮説: 画面内計測またはテスト計測だけでもPhase2目標達成可否の判定材料になる。
反証: 計測粒度が粗く、ベースライン比の再現性が不足してAC4判定に使えない。
採否理由: 性能要件が必須だが、本Issue単独で恒久的メトリクス基盤まで作ると過剰なため段階導入とする。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/prd/wooly-fluffy.md
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-ai-voice-latency-epic.md
捨て条件: 本文非保存ポリシーを侵害する計測しか成立しない場合は不採用。
リスク/検証: 計測出力に本文/STT全文が含まれないことをテストで検証する。

## 隣接領域探索

隣接領域-1
領域: 非同期キュー制御（並列prefetch + 順序再生）
観点: 並列取得と逐次消費の整合、バックプレッシャー、順序保証

隣接領域-2
領域: リアルタイム中断制御（stop/cancel）
観点: in-flightの採用判定、UI反映の世代切替、stale排除

抽象化-1
内容: 「Out-of-order到着を許容する順序付き再生キュー」

抽象化-2
内容: 「再生系の世代IDによる遅延副作用無効化」

適用マッピング
- KIOSK側で `segment_index` 順待ちキューを導入し、再生順制御を明示化する。
- stop_output時は世代IDを進め、旧世代のin-flight完了結果を採用しない。

## 下流反映（見積もりへの影響）

- 不確実性: 並列度（2 or 3）の最適値とTTFA評価方法の確定は中程度。
- リスク: 競合条件（stop_outputと遅延完了）が複数あり、テスト比重が高い。
- 工数影響: 実装よりも非同期ケースの統合テスト作成に工数が偏る。

## 探索ログ

何を調べたか:
- Issue #129 のAC、変更対象、依存関係
- PRD FR-7/AC-5/AC-E5 と性能要件
- Epic Issue-2 の設計方針（段階導入、順序保証、stop_output）
- 現行 `web/src/kiosk-page.tsx` の stale 制御と `kiosk.command.speak` 再生フロー

何を除外したか:
- サーバ側stream実装変更（Issue #130 範囲）
- TTSエンジン切替や音声フォーマット再設計
- 永続メトリクス基盤の新規導入

未解決:
- AC4の評価出力を「テストログのみ」にするか「軽量UI計測表示」まで含めるかの最小合意

タイムボックス: 100分（調査35分、既存実装読解45分、文書化20分）
打ち切り条件: AC1-4に直接関与しない改善案（UI演出/監視基盤拡張）は見積もり対象から除外する
