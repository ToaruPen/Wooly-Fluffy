# Research (Estimation): issue-92

> このテンプレートは `/research estimation` コマンドで使用されます。
> 成果物は `docs/research/estimation/issue-<n>/<YYYY-MM-DD>.md` に保存します。

---

## メタ情報

- 作成日: 2026-02-18
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #92 feat: /review-cycle 品質維持前提の収束レビュー最適化（quota/時間削減）提案

---

## 1. 調査の目的

Issue #92 の未決事項（運用先行かコア改修先行か）を、既存実装（#82）と契約互換性（/create-pr, test-review, review.json schema）を壊さずに判断できる粒度まで分解し、見積もりの不確実性を下げる。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
  - 補足: #82, #83 の関連先行が存在
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
  - 補足: Issue #92 の実装ターゲット優先順が未決
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: No
  - 補足: PRD Q6-5〜8 は No

---

## 3. 候補（必須: >= 5）

候補-1
概要: Phase 1 運用オーケストレーション先行（初回フル→収束→最終フル）を docs/commands で明文化
適用可否: Yes
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/92
- https://github.com/ToaruPen/Agentic-SDD/issues/82
- .agent/commands/review-cycle.md
捨て条件:
- 「入力を実際に削る」実装がなく、効果測定ができない場合
リスク/検証:
- リスク: ルールだけ増えて運用負荷が上がる
- 検証方法: 同一 Issue の review 実行回数と p50 実行時間を before/after 比較

候補-2
概要: `review-metadata.json` へ bytes/runtime/reuse理由を追加し計測を先行
適用可否: Yes
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/92
- scripts/review-cycle.sh
捨て条件:
- 既存 metadata 契約を破壊する変更（後方互換なし）が必要な場合
リスク/検証:
- リスク: メタデータ肥大化で可読性低下
- 検証方法: 既存テスト（`scripts/tests/test-review-cycle.sh`）で互換を確認

候補-3
概要: `MAX_DIFF_BYTES` / `MAX_PROMPT_BYTES` の fail-fast 予算ガードを導入
適用可否: Partial
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/92
- https://developers.openai.com/api/docs/guides/compaction
- https://github.com/openai/codex/issues/4398
捨て条件:
- 実運用で閾値設計根拠（過去分布）が取れず誤検知が多い場合
リスク/検証:
- リスク: 閾値が厳しすぎてレビュー不能ケースが増える
- 検証方法: 失敗率と「分割ガイドに従って再実行成功」率を計測

候補-4
概要: `/create-pr` 側で最終レビューの `diff_source=range` を必須化し最終ゲート強度を統一
適用可否: Partial
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/92
- .agent/commands/create-pr.md
捨て条件:
- 既存の test-review/create-pr 契約に対する破壊的変更が避けられない場合
リスク/検証:
- リスク: 開発ループ中の利便性低下（局所レビューのみでPR作成不可）
- 検証方法: `/create-pr` 失敗理由の内訳を観測し、運用手順に明記

候補-5
概要: A/B 比較プロトコルを導入し、最適化前後で品質劣化（P0/P1見逃し近似）を監視
適用可否: Yes
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/92
- https://developers.openai.com/codex/noninteractive
捨て条件:
- 比較対象の同一diff再現が確保できない場合
リスク/検証:
- リスク: 指標設計が曖昧でGo/No-Go判定不能
- 検証方法: KPI（reuse率、runtime、差し戻し率）を定義して閾値で判定

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: review metadata 再利用時のキャッシュ整合性（head/base/diff fingerprint）設計の一般パターンを確認し、誤再利用を防ぐ条件を明確化する。
根拠リンク:
- https://developers.openai.com/api/docs/guides/compaction
- https://github.com/openai/codex/issues/4398

隣接領域-2
概要: CI fail-fast の上限ガード（入力サイズ予算）運用を確認し、`MAX_DIFF_BYTES`/`MAX_PROMPT_BYTES` の閾値設計方針を補強する。
根拠リンク:
- https://developers.openai.com/codex/noninteractive
- https://docs.astral.sh/ruff/integrations/

抽象化-1
原理/パターン: 再利用は「一致したときだけ許可（fail-closed）」を基本とし、不一致時は常にフル実行へ戻す。

抽象化-2
原理/パターン: 最適化は観測可能性（bytes/runtime/reuse理由）を同時に追加し、品質低下時の切り戻し判断を容易にする。

適用マッピング
- PRD: `docs/prd/agentic-sdd-harness-engineering.md` の fail-closed / quality-gate 原則に一致
- Epic: `docs/epics/agentic-sdd-harness-engineering.md` の docs lint・検証強化方針に一致
- Estimation: #92 の `REVIEW_CYCLE_INCREMENTAL` と予算ガード設計（再利用条件・非再利用時フル実行）の見積もり前提に反映

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- 候補を5件以上列挙し、各候補の捨て条件と検証方法を定義できた
- 見積もり section 10 に載せる確認事項を2件以内に絞れた

---

## 6. 見積もりへの反映サマリ

- 不確実性/リスク: 実装ターゲット優先（運用先行 or コア先行）が未決、予算ガード閾値の根拠不足
- 調査で減った不確実性: 先行事例は2件以上あり、fail-closed 維持と契約非破壊を前提に段階導入できる見通しが立った
- テスト計画への影響: `scripts/tests/test-review-cycle.sh` を中心に metadata 互換・reuse条件・fail-fast条件の回帰テスト追加が必要
