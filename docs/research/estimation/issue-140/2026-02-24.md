# Issue #140 見積もり調査

- 対象Issue: #140
- 作成日: 2026-02-24
- 作成者: OpenCode

## 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD Q6 の Unknown 残件: No
- Q6-5（PII）/監査/性能/可用性のいずれかが Yes: Yes

## 候補評価

候補-1
概要: `server/src/test-helpers/http.ts` を新規作成し、`sendRequest` / `sendRequestBuffer` / `cookieFromSetCookie` / `loginStaff` / `withStaffCookie` を集約する。
適用可否: Yes
仮説: HTTPテスト共通処理を1モジュールへ統合すると、3テストファイルの重複削除と将来変更の一括反映が可能になる。
反証: 既存テストがファイル内ローカル変数（`port`/`staffCookie`）に強く依存し、共通化で可読性や失敗解析が悪化する。
採否理由: Issue AC1/AC3を最短で満たし、既存テスト契約を維持したまま差分を局所化できるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/140
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/http-server.test.ts
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/http-server.llm-async.test.ts
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/staff-access-control.test.ts
捨て条件: ポート/クッキー状態管理を共有化するためにヘルパーAPIが過剰抽象化（クラス化・状態機械化）を必要とする場合は分割提案する。
リスク/検証: 3テストすべてで import 後に同等のHTTPレスポンス（status/body/headers）が得られることを既存テストで検証する。

候補-2
概要: `server/src/test-helpers/fetch.ts` を新規作成し、`createAbortableNeverFetch` を `AbortError` 名称付きで統一する。
適用可否: Yes
仮説: `AbortSignal` 挙動テストの重複を1実装へ統合し、`AbortError` 判定のブレを解消できる。
反証: `tts-provider.test.ts` の既存期待が `name` 未設定前提に依存しており、統一後に副作用的な失敗が増える。
採否理由: Issue AC2/AC4が明示要求しており、`err.name = "AbortError"` を正とする仕様にも一致するため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/providers/llm-provider.test.ts
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/providers/tts-provider.test.ts
捨て条件: 両テストで要求される戻り値シェイプが根本的に異なり、単一実装で型安全を維持できない場合は helper を2種に分割する。
リスク/検証: Abort即時・Abortイベント発火・signal未指定の3ケースで期待エラーが一致することを確認する。

候補-3
概要: 既存テストファイルの重複実装を削除し、すべて `test-helpers` import に置換する。
適用可否: Yes
仮説: 実装削除＋import置換のみでテストの意味論を変えずに保守性を改善できる。
反証: import循環やテスト初期化順序の変化で `beforeEach`/`afterEach` の副作用が顕在化する。
採否理由: このIssueの主目的が重複排除であり、追加機能ではなく構造整理に限定できるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/140
捨て条件: 単純置換でテストの前提（可変状態参照）が壊れる場合は、ファクトリ関数化して呼び出し側の責務を明示する。
リスク/検証: 変更対象5テストを最小差分で更新し、`npm run -w server test` と `npm run -w server coverage` を通す。

候補-4
概要: `vitest.config.ts` の `coverage.exclude` 調整を同Issueで実施する。
適用可否: Partial
仮説: `test-helpers` を除外しない場合、カバレッジ分母変化で100%維持が難しくなる可能性がある。
反証: 既存カバレッジ設定がすでに helper を実質除外できており、設定変更は不要でノイズになる。
採否理由: Issue本文では「調整を検討」と記載で必須ACではないため、まず現状設定で計測し必要時のみ追加対応とする。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/140
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/vitest.config.ts
捨て条件: coverage実行で100%維持を満たせる場合は設定変更を行わない。
リスク/検証: 変更後に `npm run -w server coverage` の閾値判定を確認し、設定変更の要否を決める。

## 隣接領域探索

隣接領域-1
領域: テストユーティリティの状態注入
観点: `port` と `staffCookie` を引数・クロージャで渡す最小API設計

隣接領域-2
領域: Abort制御のエラー正規化
観点: `AbortError` 名称付与の統一とリトライ判定への影響

抽象化-1
内容: 「重複したテスト手続きは副作用境界を保ったままファクトリ化する」

抽象化-2
内容: 「中断系テストはエラー型/名前を共通化し契約を明示する」

適用マッピング
- HTTP系テストは `createHttpTestHelpers(portAccessor, staffCookieAccessor)` 相当の軽量APIで共通化する。
- Fetch系テストは `createAbortableNeverFetch` を1実装へ寄せ、Abort契約を統一する。

## 下流反映（見積もりへの影響）

- 不確実性: 低〜中（共通化自体は単純だが、テストの状態参照方式の差分に注意が必要）
- リスク: coverage除外設定の要否が実行結果依存で、軽微な追加作業が発生する可能性がある。
- 工数影響: 実装よりも置換漏れ確認と回帰テスト実行に工数が寄る。

## 探索ログ

何を調べたか:
- Issue #140 のACと変更対象候補
- 重複ヘルパーの定義位置（3テスト + provider系2テスト）
- PRD Q6-5/Q6-7 とデータ最小化・性能要件の制約

何を除外したか:
- アプリ本体ロジック（server runtime）の変更
- 新規テストフレームワーク導入や大規模リファクタ
- Issueスコープ外のテスト分割作業

未解決:
- `coverage.exclude` を調整せず100%維持できるか（実行時確認が必要）

タイムボックス: 75分（Issue読解20分、既存テスト比較35分、文書化20分）
打ち切り条件: ACに直接関係しない改善（命名統一以外の構造整理）は見積もり対象外とする。
