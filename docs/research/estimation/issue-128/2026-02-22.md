# Issue #128 見積もり調査

- 対象Issue: #128
- 作成日: 2026-02-22
- 作成者: OpenCode

## 新規性判定（発火条件）

- 直接の先行事例が2件未満: Yes
- PRD Q6 の Unknown 残件: No
- Q6-5（PII）/監査/性能/可用性のいずれかが Yes: Yes

## 候補評価

候補-1
概要: 文分割は日本語句読点（。！？）優先で切り、5文字未満の断片は次セグメントへ連結する。
適用可否: Yes
仮説: 文境界+最小文字数ルールで、可読性と初回発話の早さを両立できる。
反証: 連結ルールでも不自然な切れ目が多発し、聞き取り品質が低下する。
採否理由: AC2に直接対応し、実装複雑度を増やさずに段階導入できるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/issues/128
- https://zenn.dev/t_honda/articles/loveit-ai-voice-pipeline
捨て条件: 既存テストの日本語文ケースで分割品質が維持できない場合は不採用。
リスク/検証: 句読点が少ない入力の挙動をunit testで検証する。

候補-2
概要: `utterance_id` + `segment_index` + `is_last` を `speech.segment` の契約として固定する。
適用可否: Yes
仮説: 明示的な順序キーにより逆順/重複検知と再送耐性が作りやすい。
反証: 既存SSEメッセージ構造と衝突し、クライアント側の互換維持が困難になる。
採否理由: AC1/AC5の整合要件を最小変更で担保でき、Epic契約とも一致するため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/epics/wooly-fluffy-ai-voice-latency-epic.md
- https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events
捨て条件: `kiosk.command.speak` と排他的にしか送れず互換維持できない場合は再設計。
リスク/検証: effect-executor/http-serverの統合テストで送出順と必須フィールドを検証する。

候補-3
概要: 互換維持のため `kiosk.command.speak` を残しつつ `kiosk.command.speech.*` を追加する。
適用可否: Yes
仮説: 既存テストを壊さずに新経路を段階導入できる。
反証: 二重送出でクライアント実装が競合し、重複再生が発生する。
採否理由: Decision/Epicの互換方針に一致し、回帰リスクを抑えられるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/decisions/d-2026-02-20-ai-voice-low-latency-phased-rollout.md
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/server/src/effect-executor.ts
捨て条件: 既存 `kiosk.command.speak` の退行が解消できない場合はPhase分割を再調整。
リスク/検証: server/web既存テストを回し、`speak` 回帰なしを確認する。

候補-4
概要: TTFA観測は本文を保存しないメトリクス（ID/時刻差）で記録する。
適用可否: Partial
仮説: `chat_request_id` 起点と初回 `speech.segment` 送信時刻でPhase1比較が可能。
反証: 計測点が分散し、再現性あるベースライン比較が取れない。
採否理由: AC4を満たす方向だが、格納先と集計導線は実装時に最小構成を要検討。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/prd/wooly-fluffy.md
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/docs/decisions/d-2026-02-20-ai-voice-low-latency-phased-rollout.md
捨て条件: 本文非保存を満たせない計測設計しか成立しない場合はIssue分割を提案。
リスク/検証: メトリクス出力内容をレビューし、本文が含まれないことをテストで固定する。

候補-5
概要: stop_output 後の stale 混入防止に generation または in-flight 判定を導入する。
適用可否: Yes
仮説: 既存の stale 無視ロジックを `speech.segment` 経路へ拡張すれば AC-E5 を満たせる。
反証: stop_output と segment 到着が競合し、旧セグメント再生を抑止できない。
採否理由: 既存web側に類似制御があり、再利用で実装コストを抑えられるため。
根拠リンク:
- https://github.com/ToaruPen/Wooly-Fluffy/blob/main/web/src/kiosk-page.tsx
- https://github.com/ToaruPen/Wooly-Fluffy/issues/128
捨て条件: 競合条件をテストで安定再現できず、検証不能な場合は先にテストハーネスを整備。
リスク/検証: stop_output前後の非同期競合をintegration testで再現し、旧セグメント再生0件を確認する。

## 隣接領域探索

隣接領域-1
領域: Realtimeイベント配信（SSE順序/再接続）
観点: 順序保証、重複耐性、イベント契約の互換性

隣接領域-2
領域: 音声パイプライン（TTSキュー/割り込み）
観点: stop_output時のin-flightキャンセル、初回発話遅延

抽象化-1
内容: 「順序付き断片配信 + 明示終端」の汎用イベントパターン

抽象化-2
内容: 「低遅延化と互換維持の段階導入」パターン

適用マッピング
- Phase1は server 側の `speech.*` 送出と観測点追加を先行し、既存 `speak` を温存する。
- stop_output の stale 抑止は既存 generation 制御を流用し、同一判定軸で検証する。

## 下流反映（見積もりへの影響）

- 不確実性: TTFA観測の最小実装（記録先/出力形）が中程度の不確実性。
- リスク: `speak` 互換維持と `speech.*` 並行運用で重複再生が起きる可能性。
- 工数影響: 実装本体に加えて、回帰テストと観測系テストの比重が高い。

## 探索ログ

何を調べたか:
- Issue #128 の AC と技術メモ
- PRD FR-7 / AC-5 / AC-E5
- Epic と Decision の互換方針、影響範囲
- 既存コード（effect-executor/orchestrator/http-server/kiosk-page）の `speak` と stale 制御

何を除外したか:
- LLM provider の stream API 導入（Phase3範囲）
- KIOSK の並列プリフェッチ実装（Issue #129 範囲）
- SSEでの音声バイナリ直接配信

未解決:
- TTFAメトリクスの公開先（ログのみか、将来集計を見据えた構造化出力か）の最小合意

タイムボックス: 90分（調査30分、既存実装読解40分、文書化20分）
打ち切り条件: AC1-4に直接寄与しない派生論点は採否保留にして見積もりへ進む
