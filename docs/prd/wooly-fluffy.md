# PRD: Wooly-Fluffy

---

## メタ情報

- 作成日: 2026-01-31
- 作成者: -
- ステータス: Draft
- バージョン: 1.0

---

## 1. 目的・背景

学童の現場で、子どもが安心して話しかけられる「マスコットキャラクター」を提供する。
キャラクター性の一貫性と、現場で破綻しない運用（見守り・責任分界）を最優先にしつつ、1対1では低センシティブな範囲で「当たり障りのない記憶」を扱えるようにする。

---

## 2. 7つの質問への回答

### Q1: 解決したい問題は？

学童の現場で、子どもが話す練習や雑談をできる相手が必要だが、子どもが同時に話しかけたり誤操作が起きたりすると運用が破綻しやすい。
また、個人に紐づく体験を少しだけ良くしたいが、会話全文や音声の保存は避け、職員の確認を介した最小限の記憶のみ扱いたい。

### Q2: 誰が使う？

- 子ども（KIOSK画面でPush-to-talk操作（スペース長押し/画面ボタン）で話しかける。操作は最小。KIOSKは常設のフルHD（1920x1080）非タッチディスプレイ前提で、入力はマウス/キーボード）
- 職員（STAFF画面でPush-to-talk操作、緊急停止、記憶候補のConfirm/Deny）

### Q3: 何ができるようになる？

- `ROOM`（デフォルト）での雑談（個人紐付けの保存をしない）
- `PERSONAL(name)`（音声で名乗る）での1対1会話
- Push-to-talk（PTT）をKIOSK（デフォルトON）と職員（STAFF）で操作でき、待機中は無反応にできる
- 記憶候補（低センシティブのみ）の抽出と、子どもの「はい/いいえ」+ 職員Confirmによる保存
- 職員が `pending` の一覧を見てConfirm/Denyできる
- 子どもの発話意図に応じて、KIOSK上のキャラクターが「芸事」（例: ダンス/手をふる等）を行える（あらかじめ用意したモーションの範囲で）
- 必要に応じて、外部情報（例: 今日の天気）をツール呼び出しで参照し、回答に反映できる（許可リスト + タイムアウト + 失敗時フォールバック）

### Q4: 完成と言える状態は？

- KIOSKまたは職員がPTTを開始/終了でき、KIOSKが録音開始/停止し、STT結果に応じて会話が進む
- `"パーソナル、<name>"` で `PERSONAL(name)` に入り、無操作300秒で無言で `ROOM` に戻る
- 記憶候補が出たときに「覚えていい？」が提示され、30秒以内に「はい/いいえ」で分岐する
- 「はい」の場合のみ `pending` がSTAFF一覧に出て、職員Confirmで `confirmed` として保存される
- `ROOM` の会話全文、音声、STT全文を永続保存しない

### Q5: 作らない範囲は？

- バイオメトリクス（声紋等）による本人確認
- 録音ファイルの保存
- 会話全文ログ（`ROOM` / `PERSONAL` ともに）を永続保存
- NFCによる識別（`PERSONAL(child)`）
- 施設外からの遠隔アクセス（インターネット公開）
- 子どもの指示で任意の外部サイトへアクセス/ブラウズ/検索する機能
- Webカメラの常時稼働、映像/画像の保存、個人識別（顔認証）
- ボードゲーム等のタッチゲーム
- LLMに任意のファイル読み書き/任意コード実行の権限を与える機能（ツールは許可リストの範囲に限定する）

### Q6: 技術的制約は？

Q6-1: 既存言語/フレームワーク固定
選択: Yes
詳細（Yesの場合）: TypeScript（Node.js LTS）+ React（Vite）+ SQLite

Q6-2: デプロイ先固定
選択: Yes
詳細（Yesの場合）: 常設PC（Mac mini想定）上でローカル稼働。KIOSK/STAFFは同一LAN内のブラウザから利用。

Q6-3: 期限
選択: ない
詳細（日付の場合）: -

Q6-4: 予算上限
選択: ない
詳細（あるの場合）: -

Q6-5: 個人情報/機密データ
選択: Yes
詳細（Yesの場合）: 呼び名（`name`）と低センシティブな記憶候補を扱う。音声/会話全文/STT全文は保存しない。STAFF操作は共有パスコード+自動ロック+LAN内限定。

Q6-6: 監査ログ要件
選択: No
詳細（Yesの場合）: -

Q6-7: パフォーマンス要件
選択: No
詳細（Yesの場合）: -

Q6-8: 可用性要件
選択: No
詳細（Yesの場合）: -

### Q7: 成功指標（測り方）は？

指標-1
指標: MVPの主要フローが自動テストで検証される
目標値: PRDのAC（正常系/異常系）に対応するテストがCIで常にパスする
測定方法: `npm run test` / `npm run coverage` の結果

指標-2
指標: データ最小化が運用として守られる
目標値: 音声/会話全文/STT全文がDBに保存されず、ログにも出力されない
測定方法: DBスキーマ/ログ方針のテスト、レビュー時の確認（/sync-docs）

---

## 3. ユーザーストーリー

### US-1: 子どもが安心して話せる

```
As a 子ども,
I want to マスコットに話しかけて雑談できる,
So that 話す練習や気分転換ができる.
```

### US-2: 職員が入力を安全に制御できる

```
As a 職員,
I want to Push-to-talkで収録/送信を制御できる,
So that 誤送信や運用上の事故を減らせる.
```

### US-3: 低センシティブな記憶を職員が確認して保存できる

```
As a 職員,
I want to 記憶候補をConfirm/Denyできる,
So that 不適切な保存を防ぎつつ会話体験を少し良くできる.
```

---

## 4. 機能要件

FR-1
機能名: `ROOM`/`PERSONAL(name)` モード
説明: `ROOM` は個人保存なしの雑談。`PERSONAL(name)` は音声で名乗って開始し、無操作300秒で `ROOM` に戻る。
優先度: Must

FR-2
機能名: Push-to-talk（KIOSK/職員操作）
説明: 待機中は無反応。KIOSK（デフォルトON）と職員（STAFF）がPTT操作できる。KIOSKとSTAFFはいずれも hold-to-talk（押下中のみ収録）を前提とする。緊急停止はPTTより優先し、入力/出力を中断できる。
優先度: Must

FR-3
機能名: 記憶の同意と職員Confirm
説明: 低センシティブの候補のみ扱い、子どもの「はい/いいえ」を取りつつ、最終的な保存は職員Confirmで確定する。
優先度: Must

FR-4
機能名: STAFFアクセス制御
説明: 共有パスコード+自動ロック+LAN内限定で、STAFF画面/操作を無保護にしない。
優先度: Must

FR-5
機能名: 芸事（モーション/ジェスチャ）
説明: 会話内容に応じて、KIOSK上のキャラクターに対して「実行可能な芸事」を指示できる。芸事は事前に用意した `action_id` / `motion_id` の許可リストから選択し、未知の指示は安全に無視/代替する（会話は継続する）。
優先度: Must

FR-6
機能名: ツール呼び出し（外部情報の参照）
説明: 会話の補助として、必要に応じて外部情報（例: 天気）を取得する。LLMは「ツール呼び出しの要求」を返すだけで、実際のHTTP/API呼び出しはアプリ側で許可リストの範囲で実行する。失敗/タイムアウト時はフォールバックし、会話を止めない。
優先度: Must

---

## 5. 受け入れ条件（AC）

### 正常系

- [ ] AC-1: `"パーソナル、<name>"` の発話により `PERSONAL(name)` に遷移し、`personal_name` が反映される
- [ ] AC-2: `PERSONAL` 中に無操作300秒が経過した場合、明示アナウンス無しで `ROOM` に戻る
- [ ] AC-3: 記憶候補が出た場合「覚えていい？」が提示され、子どもが「はい」を選んだときのみ `pending` が作成される
- [ ] AC-4: 職員が `pending` をConfirmした場合、対象が `confirmed` になり、`source_quote` は `NULL` になる

### 異常系（必須: 最低1つ）

- [ ] AC-E1: 「覚えていい？」提示後、30秒以内に回答が無い場合、候補は破棄され `pending` は作成されない
- [ ] AC-E2: LAN外（プライベートIP/ローカルIPv6以外）からのSTAFF APIアクセスは拒否される
- [ ] AC-E3: STAFFの認証セッションが無い場合、STAFF APIはエラーを返し、UIは再ログインを促す
- [ ] AC-E4: 芸事/ツールの指示が無効（許可リスト外/失敗/タイムアウト）でも、会話は継続しシステムは停止しない（安全なフォールバックに落ちる）

---

## 6. 非機能要件（該当する場合）

- パフォーマンス: N/A（本PRDでは数値目標を置かない）
- 可用性: N/A（本PRDではSLA/SLOを置かない）
- セキュリティ: STAFF操作は共有パスコード+自動ロック+LAN内限定。音声/会話全文/STT全文は保存しない。
- デバッグ表示: STAFF画面にデバッグ情報を表示する場合、本文/STT全文の表示は Web開発モード（Viteの `import.meta.env.DEV === true` 相当）かつ `VITE_STAFF_DEBUG_SHOW_BODY` が有効のときのみ（`unset/0/false` は無効、`1/true` は有効。RAM上の一時データ、永続化なし、server consoleにも出さない。無効時はSTAFFデバッグ表示用の本文/STT全文を生成・保持・送信しない）。詳細は ADR-13 を参照。
- その他: 推定結果を根拠に感情を断定する発話はしない

---

## 7. 規模感と技術方針

- 規模感: 小規模
- 技術方針: シンプル優先

---

## 8. 用語集

用語-1
用語: KIOSK
定義: 子ども向けの表示画面（操作は最小）。常設のフルHD（1920x1080）非タッチディスプレイ前提。

用語-2
用語: STAFF
定義: 職員向けの操作画面（PTT、緊急操作、記憶Confirm/Deny）。

用語-3
用語: pending / confirmed
定義: pendingは子どもが「はい」と言った候補（職員Confirm待ち）。confirmedは職員Confirm済みの想起対象。

---

## 変更履歴

- 2026-01-31: v1.0 初版作成（migration）
