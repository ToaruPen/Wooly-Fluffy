# PRD: Wooly-Fluffy

---

## メタ情報

- 作成日: 2026-01-31
- 作成者: -
- ステータス: Draft
- バージョン: 1.1

---

## 1. 目的・背景

学童の現場で、子どもが安心して話しかけられる「マスコットキャラクター」を提供する。
キャラクター性の一貫性と、現場で破綻しない運用（見守り・責任分界）を最優先にしつつ、会話セッション単位の「要約」を職員が確認して残せるようにする。
加えて、AI応答時の初回発話遅延を下げるため、文単位の段階出力を前提にした低遅延音声パイプラインを導入する。

---

## 2. 7つの質問への回答

### Q1: 解決したい問題は？

学童の現場で、子どもが話す練習や雑談をできる相手が必要だが、子どもが同時に話しかけたり誤操作が起きたりすると運用が破綻しやすい。
また、現場の振り返り（その日に何があったか）を助けたいが、会話全文や音声の保存は避け、職員確認を介したセッション要約のみ扱いたい。

### Q2: 誰が使う？

- 子ども（KIOSK画面でPush-to-talk操作（スペース長押し/画面ボタン）で話しかける。操作は最小。KIOSKは常設のフルHD（1920x1080）非タッチディスプレイ前提で、入力はマウス/キーボード）
- 職員（STAFF画面でPush-to-talk操作、緊急停止、セッション要約候補のConfirm/Deny）

### Q3: 何ができるようになる？

- モード表示なし（`ROOM`/`PERSONAL` 等の表示や切り替え操作を子ども側に出さない）
- 会話はroomセッションとして扱い、最後の会話からアイドル5分でセッション終了できる
- Push-to-talk（PTT）をKIOSK（デフォルトON）と職員（STAFF）で操作でき、待機中は無反応にできる
- セッション終了時に「短いタイトル + 要約（構造化JSON）」を生成し、`pending` として保存できる（pendingは7日で自動失効）
- 職員が `pending` をConfirm/Denyできる（Confirmは永続、Denyは削除）
- 子どもの発話意図に応じて、KIOSK上のキャラクターが「芸事」（例: ダンス/手をふる等）を行える（あらかじめ用意したモーションの範囲で）
- 必要に応じて、外部情報（例: 今日の天気）をツール呼び出しで参照し、回答に反映できる（許可リスト + タイムアウト + 失敗時フォールバック）
- AI応答（台本固定を除く）は、文単位で段階的に音声出力できる（順序保証あり）

### Q4: 完成と言える状態は？

- KIOSKまたは職員がPTTを開始/終了でき、KIOSKが録音開始/停止し、STT結果に応じて会話が進む
- 会話が行われた後、アイドル5分でセッションが終了し、セッション要約が `pending` として作成される
- `pending` は7日で自動失効し、職員が Confirm/Deny できる
- 職員Confirmされた要約（`confirmed`）は永続化され、Denyされた要約は削除される
- 会話全文、音声、STT全文を永続保存しない（永続化するのはセッション要約のみ）

### Q5: 作らない範囲は？

- バイオメトリクス（声紋等）による本人確認
- 録音ファイルの保存
- 会話全文ログを永続保存
- 施設外からの遠隔アクセス（インターネット公開）
- 子どもの指示で任意の外部サイトへアクセス/ブラウズ/検索する機能
- Webカメラの常時稼働、映像/画像の保存、個人識別（顔認証）
- ボードゲーム等のタッチゲーム
- LLMに任意のファイル読み書き/任意コード実行の権限を与える機能（ツールは許可リストの範囲に限定する）

### Q6: 技術的制約は？

Q6-1: 既存言語/フレームワーク固定
選択: Yes
詳細（Yesの場合）: TypeScript（Node.js LTS）+ React（Vite）+ SQLite

Q6-2: デプロイ先固定
選択: Yes
詳細（Yesの場合）: 常設PC（Mac mini想定）上でローカル稼働。KIOSK/STAFFは同一LAN内のブラウザから利用。

Q6-3: 期限
選択: ない
詳細（日付の場合）: -

Q6-4: 予算上限
選択: ない
詳細（あるの場合）: -

Q6-5: 個人情報/機密データ
選択: Yes
詳細（Yesの場合）: セッション要約（短文・抽象化・構造化JSON）を扱う。音声/会話全文/STT全文は保存しない。STAFF操作は共有パスコード+自動ロック+LAN内限定。

Q6-6: 監査ログ要件
選択: No
詳細（Yesの場合）: -

Q6-7: パフォーマンス要件
選択: Yes
詳細（Yesの場合）: 段階導入でTTFA（最初の音が出るまで）を改善する。Phase1: ベースライン比10-20%改善、Phase2: 20-30%改善、Phase3: 30%以上改善を目標にする。stop_output反映は p95 300ms（最終目標200ms）以内。

Q6-8: 可用性要件
選択: No
詳細（Yesの場合）: -

### Q7: 成功指標（測り方）は？

指標-1
指標: MVPの主要フローが自動テストで検証される
目標値: PRDのAC（正常系/異常系）に対応するテストがCIで常にパスする
測定方法: `npm run test` / `npm run coverage` の結果

指標-2
指標: データ最小化が運用として守られる
目標値: 音声/会話全文/STT全文がDBに保存されず、ログにも出力されない
測定方法: DBスキーマ/ログ方針のテスト、レビュー時の確認（/sync-docs）

指標-3
指標: AI応答の体感遅延と順序整合
目標値: TTFAを段階目標どおり改善し、順序違反0件/重複再生0件を維持する
測定方法: `utterance_id`/`segment_index` ベースのメトリクス（本文は記録しない）

---

## 3. ユーザーストーリー

### US-1: 子どもが安心して話せる

```
As a 子ども,
I want to マスコットに話しかけて雑談できる,
So that 話す練習や気分転換ができる.
```

### US-2: 職員が入力を安全に制御できる

```
As a 職員,
I want to Push-to-talkで収録/送信を制御できる,
So that 誤送信や運用上の事故を減らせる.
```

### US-3: セッション要約を職員が確認して保存できる

```
As a 職員,
I want to セッション要約候補をConfirm/Denyできる,
So that 不適切な保存を防ぎつつ振り返りに活用できる.
```

---

## 4. 機能要件

FR-1
機能名: セッション管理（モード表示なし）
説明: 会話はroomセッションとして扱い、最後の会話からアイドル5分でセッションを終了する。セッション終了時に「短いタイトル + 要約（構造化JSON）」を `pending` として作成し、職員Confirm/Denyの対象にする。
優先度: Must

FR-2
機能名: Push-to-talk（KIOSK/職員操作）
説明: 待機中は無反応。KIOSK（デフォルトON）と職員（STAFF）がPTT操作できる。KIOSKとSTAFFはいずれも hold-to-talk（押下中のみ収録）を前提とする。緊急停止はPTTより優先し、入力/出力を中断できる。
優先度: Must

FR-3
機能名: セッション要約の職員レビュー（pending/confirmed）
説明: セッション要約を `pending` として作成し、職員がConfirm/Denyできる。pendingは7日で自動失効し、Confirmされた要約（confirmed）は永続化する。会話全文/音声/STT全文は保存しない。
優先度: Must

FR-4
機能名: STAFFアクセス制御
説明: 共有パスコード+自動ロック+LAN内限定で、STAFF画面/操作を無保護にしない。
優先度: Must

FR-5
機能名: 芸事（モーション/ジェスチャ）
説明: 会話内容に応じて、KIOSK上のキャラクターに対して「実行可能な芸事」を指示できる。芸事は事前に用意した `action_id` / `motion_id` の許可リストから選択し、未知の指示は安全に無視/代替する（会話は継続する）。
優先度: Must

FR-6
機能名: ツール呼び出し（外部情報の参照）
説明: 会話の補助として、必要に応じて外部情報（例: 天気）を取得する。LLMは「ツール呼び出しの要求」を返すだけで、実際のHTTP/API呼び出しはアプリ側で許可リストの範囲で実行する。失敗/タイムアウト時はフォールバックし、会話を止めない。
優先度: Must

FR-7
機能名: 低遅延AI音声出力（文単位）
説明: AI応答（台本固定を除く）は、LLM出力を文境界で分割し、順序保証されたセグメントとして段階出力する。既存契約を壊さない拡張互換で導入し、stop_outputで即時中断できる。
優先度: Must

---

## 5. 受け入れ条件（AC）

### 正常系

- [x] AC-1: 会話が行われた後、アイドル5分でセッションが終了し、要約（短いタイトル + 構造化JSON）が `pending` として作成される
- [x] AC-2: `pending` は7日で自動失効（削除）する
- [x] AC-3: 職員が `pending` をConfirmした場合、対象が `confirmed` になり、`confirmed` は期限なしで保持される
- [x] AC-4: 職員が `pending` をDenyした場合、対象は削除される（本文保持しない）
- [x] AC-5: AI応答は文単位で段階的に音声出力され、セグメント順序が維持される（逆順/重複なし）

### 異常系（必須: 最低1つ）

- [x] AC-E1: セッション要約の生成が失敗/タイムアウトした場合でも、会話は継続しシステムは停止しない（安全なフォールバックに落ちる）
- [x] AC-E2: LAN外（プライベートIP/ローカルIPv6以外）からのSTAFF APIアクセスは拒否される
- [x] AC-E3: STAFFの認証セッションが無い場合、STAFF APIはエラーを返し、UIは再ログインを促す
- [x] AC-E4: 芸事/ツールの指示が無効（許可リスト外/失敗/タイムアウト）でも、会話は継続しシステムは停止しない（安全なフォールバックに落ちる）
- [x] AC-E5: stop_output指示後、in-flightの旧セグメントが再生されない（stale混入を防止）

---

## 6. 非機能要件（該当する場合）

- パフォーマンス: AI応答のTTFAを段階導入で改善（Phase1: -10〜20%、Phase2: -20〜30%、Phase3: -30%以上、いずれもベースライン比）。stop_output反映は p95 300ms（最終目標200ms）以内。
- 可用性: N/A（本PRDではSLA/SLOを置かない）
- セキュリティ: STAFF操作は共有パスコード+自動ロック+LAN内限定。会話全文/音声/全文STTは保存しない。セッション要約は逐語引用を避け、個人特定情報を一般化し、構造化JSON（スキーマ固定）として保存前にバリデーション/簡易マスクを行う。
- デバッグ表示: STAFF画面にデバッグ情報を表示する場合、本文/STT全文の表示は Web開発モード（Viteの `import.meta.env.DEV === true` 相当）かつ `VITE_STAFF_DEBUG_SHOW_BODY` が有効のときのみ（`unset/0/false` は無効、`1/true` は有効。RAM上の一時データ、永続化なし、server consoleにも出さない。無効時はSTAFFデバッグ表示用の本文/STT全文を生成・保持・送信しない）。詳細は ADR-13 を参照。
- その他: 推定結果を根拠に感情を断定する発話はしない

---

## 7. 規模感と技術方針

- 規模感: 小規模
- 技術方針: シンプル優先

---

## 8. 用語集

用語-1
用語: KIOSK
定義: 子ども向けの表示画面（操作は最小）。常設のフルHD（1920x1080）非タッチディスプレイ前提。

用語-2
用語: STAFF
定義: 職員向けの操作画面（PTT、緊急操作、セッション要約Confirm/Deny）。

用語-3
用語: pending / confirmed
定義: pendingはセッション要約の職員確認待ち（7日で自動失効）。confirmedは職員Confirm済みのセッション要約（期限なし）。

---

## 変更履歴

- 2026-01-31: v1.0 初版作成（migration）
- 2026-02-20: v1.1 低遅延AI音声パイプライン要件（FR-7/AC-5/AC-E5、段階的性能目標）を追加
- 2026-02-27: v1.1 AC全項目を充足確認済みに更新（#114-#119, #128-#130 完了）
