# Agentic-SDD 最終設計（v3）

## 変更履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| v1 | - | 初版（5つの未決事項を確定） |
| v2 | - | 分析担当レビュー反映（矛盾修正、具体化、補強） |
| v3 | - | 最終レビュー反映（カウント定義、Q6選択式、異常系AC、信頼度、例外必須欄、Full必須） |

---

## 1. PRD完成条件（v3）

### 1.1 AI質問フェーズ（7問）

```
Q1: 解決したい問題は？
Q2: 誰が使う？
Q3: 何ができるようになる？
Q4: 完成と言える状態は？
Q5: 作らない範囲は？
Q6: 技術的制約は？（選択式）← v3で選択式に変更
Q7: 成功指標（測り方）は？
```

### 1.2 Q6: 技術的制約（選択式）← v3で追加

| 項目 | 選択肢 | 備考 |
|-----|-------|------|
| 既存言語/フレームワーク固定 | Yes / No / Unknown | Yesなら具体名を記載 |
| デプロイ先固定 | Yes / No / Unknown | Yesなら環境名を記載 |
| 期限 | [日付] / Unknown | Unknownなら優先度判断が不確実 |
| 予算上限 | ある / ない / Unknown | Unknownなら外部サービスは原則禁止 |
| 個人情報/機密データ | Yes / No / Unknown | Yesならセキュリティ要件必須（→ `.agent/rules/security.md`） |
| 監査ログ要件 | Yes / No / Unknown | Yesなら観測性要件必須（→ `.agent/rules/observability.md`） |
| パフォーマンス要件 | Yes / No / Unknown | Yesならパフォーマンス設計必須（→ `.agent/rules/performance.md`） |
| 可用性要件 | Yes / No / Unknown | Yesなら可用性設計必須（→ `.agent/rules/availability.md`） |

**Unknown運用ルール:**
- Unknownを選んだ項目は、次のフェーズ（Epic生成）で確認質問が必須
- 2つ以上Unknownがある場合、PRD完成とみなさない

### 1.3 完成チェックリスト

```
□ 目的・背景が1-3文で書かれている
□ ユーザーストーリーが1つ以上ある
□ 機能要件が3つ以上列挙されている
□ ACが検証可能な形式で3つ以上ある
□ ACに異常系（エラー/権限不足/入力不正）が最低1つある ← v3で追加
□ スコープ外が明記されている
□ 曖昧な表現がない（禁止語辞書参照）
□ 数値・条件が具体的
□ 成功指標が測定可能な形式で書かれている
□ Q6のUnknownが2つ未満である ← v3で追加
```

### 1.4 禁止語辞書

| 禁止語 | 言い換え例 |
|-------|----------|
| 適切に | 「〜の条件を満たす場合」 |
| なるべく | 「〜以上/以下」 |
| できるだけ | 「最大〜まで」「最小〜」 |
| 高速 | 「〜秒以内」「〜ms以内」 |
| 簡単に | 「〜ステップで」「〜クリックで」 |
| ユーザーフレンドリー | 具体的なUI要件を列挙 |
| 柔軟に | 「〜の場合は〜、〜の場合は〜」 |

### 1.5 ACガイド

ACは**観測可能**なものに限定する：

| OK | NG |
|----|----|
| 「〜画面に〜が表示される」 | 「使いやすい」 |
| 「HTTPステータス200が返る」 | 「速い」 |
| 「DBに〜レコードが作成される」 | 「問題なく動く」 |
| 「ログに〜が出力される」 | 「エラーが起きない」 |
| 「エラー時に〜メッセージが表示される」← 異常系例 | 「エラーが適切に処理される」 |

### 1.6 良い/悪い回答例

**Q1: 解決したい問題は？**

| 良い例 | 悪い例 |
|-------|-------|
| 「毎月の経費精算に3時間かかっている。これを30分以内にしたい」 | 「経費精算を楽にしたい」 |

**Q4: 完成と言える状態は？**

| 良い例 | 悪い例 |
|-------|-------|
| 「ユーザーがログインし、経費を入力し、承認者に通知が届く」 | 「経費精算ができる」 |

**異常系ACの例（v3で追加）:**

| 良い例 | 悪い例 |
|-------|-------|
| 「入力が空の場合、"必須項目です"とエラーメッセージが表示される」 | 「バリデーションが動く」 |
| 「権限がないユーザーがアクセスした場合、403ページが表示される」 | 「権限チェックされる」 |

---

## 2. Epic過剰提案抑止（v3）

### 2.1 Layer 1: PRD制約

```
規模感: 個人/小規模/中規模/大規模
技術方針: シンプル優先/バランス/拡張性優先
既存制約: Q6の選択結果を参照
```

### 2.2 Layer 2: AIルール

#### 2.2.1 カウント定義（v3で追加）

| 用語 | 定義 | カウント単位 |
|-----|------|-------------|
| **外部サービス数** | ネットワーク越しに依存する別管理のサービス | SaaS、マネージドDB、認証基盤、外部API を各1 |
| **コンポーネント数** | デプロイ単位 | 別プロセス、別ジョブ、別ワーカー、別バッチ を各1 |
| **新規技術** | 新規に導入する主要技術カテゴリ | DB、キュー、認証、観測基盤、フレームワーク、クラウドサービス を各1 |

#### 2.2.2 許可/禁止リスト

**「シンプル優先」時の制限:**

| 項目 | 上限/制限 |
|-----|---------|
| 外部サービス数 | 最大1（例: DBのみ） |
| 新規導入ライブラリ | 最大3 |
| 新規コンポーネント数 | 最大3 |
| 非同期基盤（キュー/イベントストリーム） | **禁止** |
| マイクロサービス分割 | **禁止** |
| コンテナオーケストレーション（K8s等） | **禁止** |

**「バランス」時の制限:**

| 項目 | 上限/制限 |
|-----|---------|
| 外部サービス数 | 最大3 |
| 新規導入ライブラリ | 最大5 |
| 新規コンポーネント数 | 最大5 |
| 非同期基盤 | 要明示的理由 |
| マイクロサービス分割 | 要明示的理由 |

**例外条件**: PRDに明記された必須条件がある場合のみ許可

#### 2.2.3 生成ルール

- 単純な代替案がある場合は**必ず両方提示**
- 「シンプル優先」時はモノリシック構成を基本とする
- 「将来の拡張性」だけを理由にした複雑化は禁止

#### 2.2.4 必須提出物（v3で追加）

Epicには以下の表を**必ず**付ける：

**外部サービス一覧:**
| 名称 | 用途 | 必須理由 | 代替案 |
|-----|------|---------|-------|
| (例) PostgreSQL | データ永続化 | RDB必須 | SQLite（小規模なら） |

**コンポーネント一覧:**
| 名称 | 責務 | デプロイ形態 |
|-----|------|-------------|
| (例) API Server | HTTPリクエスト処理 | コンテナ |

**新規技術一覧:**
| 名称 | 既存との差 | 導入理由 |
|-----|----------|---------|
| (例) Redis | 新規導入 | セッション管理 |

### 2.3 Layer 3: レビュー観点

**「技術用語5つ以下」の定義:**
- カウント対象: **新規に導入/提案する技術名・サービス名のみ**
- カウント除外: 既存プロジェクトで使用中の技術

**チェックリスト:**
```
□ 新規技術/サービス名が5つ以下
□ 新規コンポーネント数が上限以内
□ 各選択に「なぜこれを選んだか」の理由がある
□ 代替案（よりシンプルな方法）が提示されている
□ 「将来のため」だけを理由にした項目がない
□ 必須提出物（3つの一覧表）が揃っている ← v3で追加
```

---

## 3. Issue粒度規約（v3）

### 3.1 原則

| 指標 | 目安 |
|-----|------|
| 変更行数 | 50〜300行 |
| 変更ファイル数 | 1〜5ファイル |
| AC数 | 2〜5個 |

### 3.2 大きすぎるサイン（分割が必要）

- 変更行数が300行を超える見込み
- 変更ファイル数が6ファイル以上
- ACが6個以上ある
- 「〜と〜と〜をする」のように複数の動詞がある

### 3.3 小さすぎるサイン（統合を検討）

- 変更行数が50行未満
- ACが1個だけ
- 他のIssueと常にセットで作業する

### 3.4 例外ラベル（v3で必須記入欄を追加）

原則を外れる場合は、以下のラベルを付与し**必須項目を記入**：

| ラベル | 用途 | 必須記入: 理由 | 必須記入: 影響/レビュー観点 | 必須記入: 想定リスク |
|-------|------|--------------|--------------------------|-------------------|
| `bulk-format` | 自動整形/リネーム | 整形ツール名 | 機能変更がないことを確認 | 意図しない変更混入 |
| `test-heavy` | テスト追加で行数増 | テスト対象 | テストカバレッジ確認 | テスト漏れ |
| `config-risk` | 設定変更で影響大 | 変更内容 | 影響範囲の特定 | 設定ミスによる障害 |
| `refactor-scope` | リファクタで広範囲 | リファクタ目的 | 既存動作の維持確認 | 予期しない動作変更 |

### 3.5 依存関係の表現

- Issue本文に「Blocked by #xxx」を記載
- Issue本文に「先に終わると何が可能になるか」を1行追加
- ラベル「blocked」「parallel-ok」を活用

---

## 4. 見積もりルール（v3）

### 4.1 Core Rules

```
1. 見積もりは"レンジ"で出す（例: 2〜4h / 50〜100行）
2. レンジの根拠を"観測事実"に紐づける
   - 類似変更の実績
   - 影響範囲（ファイル数、依存関係）
   - 既存テストの有無
3. 不確実な点は Unknown として明示し、質問を出す
4. Unknown が解消されるまで見積もりは暫定扱い
5. 信頼度を必ず付与する ← v3で追加
```

### 4.2 信頼度（v3で追加）

| 信頼度 | 定義 | 運用ルール |
|-------|------|----------|
| **High** | 類似実績あり、影響範囲が明確 | レンジは狭くてOK |
| **Med** | 一部不確実だがレンジ内で収まる見込み | レンジはやや広めに |
| **Low** | 不確実性が高い、Unknownが残っている | レンジを広げる or Unknown質問を増やす |

**Lowの場合の対応:**
- レンジを2倍に広げる（例: 2〜4h → 2〜8h）
- または、Unknownを解消する質問を出して再見積もり

### 4.3 Full必須（v3で変更）

**初回サイクルから Full（11セクション）を必須とする。**

該当しないセクションは「N/A」と明記し、空欄にしない。

**Full（11セクション）:**
```
0. 前提確認
1. 依頼内容の解釈
2. 変更対象（ファイル:行）
3. 作業項目と工数（レンジ + 信頼度）
4. DB影響                          ← 該当なしは「N/A（DB変更なし）」
5. ログ出力                        ← 該当なしは「N/A（ログ変更なし）」
6. I/O一覧                         ← 該当なしは「N/A（外部I/Oなし）」
7. リファクタ候補                   ← 該当なしは「N/A（理由を明記）」
8. フェーズ分割                     ← 該当なしは「N/A（単一フェーズ）」
9. テスト計画
10. 矛盾点/不明点/確認事項
11. 変更しないこと
```

**N/A記載ルール:**
- 「N/A」だけでなく、理由を括弧で添える
- 例: 「N/A（本Issueはフロントエンドのみ、DB操作なし）」

---

## 5. docsの正本ルール（v3）

### 5.1 正本の階層

```
PRD（要件）  ← 最も優先度が高い
   │
   ▼
Epic（実装計画）
   │
   ▼
実装（コード）
```

### 5.2 /sync-docs の出力形式（v3で参照必須化）

出力テンプレの正本は `.agent/rules/docs-sync.md` に定義する（commands/agents からは参照する）。

ポイント:

- 差分の種類（仕様変更/解釈変更/実装都合）を分類する
- 推奨アクション（PRD更新/Epic更新/実装修正/差分なし）を明示する
- 参照（PRD/Epic/該当コードの `file:line`）を必ず付ける

### 5.3 実行タイミング

| タイミング | 実行 | 理由 |
|-----------|------|------|
| PR作成時 | **必須（DoD）** | 乖離を検出 |
| マージ後 | 推奨 | 確認用 |
| 実装中の大きな変更時 | 推奨 | 早期発見 |

---

## 6. 最終構造（v3）

```
Agentic-SDD/
├── .agent/
│   ├── commands/
│   │   ├── init.md
│   │   ├── create-prd.md
│   │   ├── create-epic.md
│   │   ├── create-issues.md
│   │   ├── create-pr.md
│   │   ├── estimation.md
│   │   ├── impl.md
│   │   ├── tdd.md
│   │   ├── review-cycle.md
│   │   ├── final-review.md
│   │   ├── sync-docs.md
│   │   └── worktree.md
│   ├── schemas/
│   │   └── review.json          # review schema v3 (review-cycle output)
│   ├── rules/
│   │   ├── datetime.md
│   │   ├── commit.md
│   │   ├── issue.md
│   │   ├── branch.md
│   │   ├── dod.md
│   │   ├── epic.md              # カウント定義 + 許可/禁止リスト
│   │   ├── impl-gate.md          # 実装ゲート（見積もり/テスト/レビュー）
│   │   └── docs-sync.md         # 出力形式 + 参照必須
│   └── agents/
│       ├── docs.md
│       └── reviewer.md
├── skills/
│   ├── README.md
│   ├── api-endpoint.md
│   ├── crud-screen.md
│   ├── error-handling.md
│   ├── testing.md
│   ├── tdd-protocol.md
│   ├── estimation.md            # Full必須 + 信頼度
│   └── worktree-parallel.md
├── docs/
│   ├── prd/
│   │   └── _template.md         # 7問(Q6選択式) + 禁止語 + 異常系AC
│   ├── epics/
│   │   └── _template.md         # 必須提出物（3一覧）含む
│   ├── data-model.md
│   ├── decisions.md             # テンプレ付き
│   └── glossary.md              # 用語集
├── .github/
│   ├── ISSUE_TEMPLATE/
│   │   ├── feature.md           # 例外ラベル必須記入欄含む
│   │   └── bug.md
│   └── PULL_REQUEST_TEMPLATE.md
├── templates/
│   ├── opencode/
│   ├── codex/
│   ├── claude/
│   └── ci/                       # opt-in CI templates (e.g. GitHub Actions)
├── scripts/
│   ├── agentic-sdd
│   ├── bench-sdd-docs.py
│   ├── install-agentic-sdd.sh
│   ├── assemble-sot.py
│   ├── create-approval.py
│   ├── create-pr.sh
│   ├── check-commit-gate.py
│   ├── check-impl-gate.py
│   ├── validate-worktree.py
│   ├── extract-issue-files.py
│   ├── review-cycle.sh
│   ├── resolve-sync-docs-inputs.py
│   ├── setup-githooks.sh
│   ├── setup-global-agentic-sdd.sh
│   ├── sot_refs.py
│   ├── sync-agent-config.sh
│   ├── test-create-pr.sh
│   ├── test-install-agentic-sdd.sh
│   ├── test-review-cycle.sh
│   ├── test-sync-docs-inputs.sh
│   ├── test-worktree.sh
│   ├── validate-approval.py
│   ├── validate-review-json.py
│   └── worktree.sh
├── .githooks/
│   ├── pre-commit
│   └── pre-push
├── .claude/
│   └── settings.json            # Claude Code hooks (gate enforcement)
├── AGENTS.md
└── README.md
```

---

## 7. 実装優先度

| 順位 | 対象 | ファイル |
|-----|------|---------|
| 1 | PRD関連 | `create-prd.md`, `docs/prd/_template.md` |
| 2 | 正本ルール | `docs-sync.md`, `dod.md`, `sync-docs.md` |
| 3 | Epic関連 | `create-epic.md`, `epic.md`, `docs/epics/_template.md` |
| 4 | Issue関連 | `create-issues.md`, `issue.md` |
| 5 | レビュー | `review-cycle.md`, `final-review.md` |
| 6 | 実装 | `impl.md`, `estimation.md` |

---

## 8. 最小構成（Must）

```
.agent/commands/
├── init.md
├── create-prd.md
├── create-epic.md
├── create-issues.md
├── final-review.md
└── sync-docs.md

.agent/rules/
├── docs-sync.md
├── dod.md
├── epic.md
└── issue.md

docs/
├── prd/_template.md
├── epics/_template.md
├── decisions.md          # テンプレ付き（Must昇格）
└── glossary.md           # 用語定義（Must昇格）

README.md
AGENTS.md
```

---

## 9. 初回サイクル成功ガイド（v3）

### 9.1 題材の選び方

- **推奨**: 小さすぎず、単一機能
- **避ける**: 外部サービス連携多数、認証、大規模リファクタ

### 9.2 初回サイクルの運用ルール

| 項目 | 初回ルール | 理由 |
|-----|----------|------|
| 見積もり | **Full必須** | 該当なしは「N/A」と明記。甘い見積もりを防ぐ |
| 例外ラベル | **使わない** | 必要になったら使う |
| 技術方針 | **シンプル優先** | 制限を体感する |
| Q6のUnknown | **0を目指す** | 不確実性を減らす |

### 9.3 成功判定

以下をすべて満たせば初回サイクル成功：
- [ ] PRDが完成チェックリストをすべて満たす
- [ ] Epicに3つの一覧表がすべてある
- [ ] Issueが粒度規約（50〜300行）に収まる
- [ ] 見積もりがFull（11セクション）で作成されている
- [ ] /sync-docsで「差分なし」になる
- [ ] /review-cycle で review.json が生成できる
- [ ] CIが通る（適用される場合）
- [ ] PRがマージされる

---

## 10. v3での主な変更点まとめ

| 項目 | v2 | v3 |
|-----|----|----|
| Q6（技術的制約） | 自由記述 | **選択式** |
| AC異常系 | なし | **最低1つ必須** |
| カウント定義 | なし | **外部サービス/コンポーネント/新規技術を定義** |
| Epic必須提出物 | なし | **3つの一覧表必須** |
| review-cycle | なし | **review.json によるローカル反復** |
| 見積もり信頼度 | なし | **High/Med/Low必須** |
| 見積もりモード | Lite/Full選択 | **Full必須** |
| 例外ラベル | ラベルのみ | **必須記入欄追加** |
| sync-docs参照 | 任意 | **PRD/Epic章番号必須** |
