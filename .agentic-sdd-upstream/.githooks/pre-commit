#!/bin/sh
set -eu

if ! command -v python3 >/dev/null 2>&1; then
  echo "[agentic-sdd gate] BLOCKED: python3 is required for approval validation." >&2
  exit 1
fi

ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$ROOT" ]; then
  exit 0
fi

cd "$ROOT"

approval_py=""
worktree_py=""
if [ -f "scripts/agentic-sdd/validate-approval.py" ]; then
  approval_py="scripts/agentic-sdd/validate-approval.py"
  worktree_py="scripts/agentic-sdd/validate-worktree.py"
elif [ -f "scripts/validate-approval.py" ]; then
  approval_py="scripts/validate-approval.py"
  worktree_py="scripts/validate-worktree.py"
fi

if [ -z "$approval_py" ]; then
  exit 0
fi

if [ ! -f "$worktree_py" ]; then
  echo "[agentic-sdd gate] BLOCKED: validate-worktree.py is missing. Reinstall/upgrade Agentic-SDD." >&2
  exit 1
fi

python3 "$worktree_py"
python3 "$approval_py"

# Python lint gate (Stage 1): ruff
need_ruff=0
changed="$(git diff --cached --name-only --diff-filter=ACMR 2>/dev/null || true)"
if printf '%s\n' "$changed" | grep -Eq '^scripts/.*\.py$|^pyproject\.toml$|^requirements-dev\.txt$'; then
  need_ruff=1
fi

if [ "$need_ruff" -eq 1 ]; then
  ruff_cmd=""
  if command -v ruff >/dev/null 2>&1; then
    ruff_cmd="ruff"
  elif python3 -m ruff --version >/dev/null 2>&1; then
    ruff_cmd="python3 -m ruff"
  else
    echo "[agentic-sdd gate] BLOCKED: ruff is required for Python lint." >&2
    echo "[agentic-sdd gate] Install: python3 -m pip install -r requirements-dev.txt" >&2
    exit 1
  fi
  # shellcheck disable=SC2086
  $ruff_cmd check scripts
  # shellcheck disable=SC2086
  $ruff_cmd format --check scripts
fi
