# Research (Estimation): issue-126

> このテンプレートは `/research estimation` コマンドで使用されます。
> 成果物は `docs/research/estimation/issue-<n>/<YYYY-MM-DD>.md` に保存します。

---

## メタ情報

- 作成日: 2026-02-25
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #126 feat: /review-cycle に advisory exploration lane を導入する

---

## 1. 調査の目的

Issue #126 の実装前に、既存の `/review-cycle` 契約（`review.json` schema v3 と `review-metadata.json`、`/create-pr` 前提）を壊さず advisory lane を導入するための実装候補を比較し、見積もり不確実性を下げる。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: Yes
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: No

---

## 3. 候補（必須: >= 5）

候補-1
概要: advisory lane を `scripts/review-cycle.sh` の前段として追加し、既存最終判定 JSON 生成は維持する
適用可否: Yes
仮説: 既存 `review.json` 生成経路に触れず、前段で補助的な探索結果を生成すれば契約互換を保てる
反証: advisory 有効時に `review.json` の schema 検証または `/create-pr` 連携が壊れる
採否理由: AC2/AC3 を最も満たしやすく、変更範囲を `review-cycle` 内に限定できる
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/126
- https://github.com/ToaruPen/Agentic-SDD/issues/124
捨て条件:
- 最終判定ロジックに分岐が混入し、既存 JSON 契約を破る場合
リスク/検証:
- リスク: 追加レイヤが失敗時の挙動を不透明化する
- 検証方法: `scripts/tests/test-review-cycle.sh` に lane on/off の回帰追加

候補-2
概要: lane の on/off を明示的な環境変数で制御し、デフォルトは off（現行互換）にする
適用可否: Yes
仮説: 明示的トグルで導入すれば既存運用への影響を最小化できる
反証: デフォルト値変更で既存 CI/ローカル運用が変化する
採否理由: AC4（既定値は現行互換）を直接満たす
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/126
- scripts/review-cycle.sh
捨て条件:
- トグルが暗黙有効化される設計しか取れない場合
リスク/検証:
- リスク: 環境変数命名が既存規約と衝突する
- 検証方法: help/command ドキュメントとテストを同時更新

候補-3
概要: advisory 出力を `review.json` とは別ファイルに保存する（最終ゲート出力と分離）
適用可否: Yes
仮説: 出力分離により schema v3 互換性を維持しつつ探索情報を保持できる
反証: 出力分離しても既存メタデータ参照側で整合性問題が発生する
採否理由: Issue AC1/AC2 の要件に合致し、契約境界が明確
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/126
- scripts/create-pr.sh
捨て条件:
- 既存 downstream が単一ファイル前提で分離不可な場合
リスク/検証:
- リスク: 出力ファイル増加で掃除や追跡が煩雑化する
- 検証方法: `.agentic-sdd/reviews/<scope>/<run>/` の成果物契約をテストで固定

候補-4
概要: `/review-cycle` ドキュメントに advisory lane の制約（最終判定は既存ゲート）を明記する
適用可否: Yes
仮説: 運用ガードを文書化しないと誤用で契約逸脱が起きる
反証: 実装のみで誤用が十分防げ、ドキュメント更新不要
採否理由: 実装意図と運用手順を同期し、再発防止に寄与する
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/blob/main/.agent/commands/review-cycle.md
- https://github.com/ToaruPen/Agentic-SDD/blob/main/README.md
捨て条件:
- 実装仕様が未確定でドキュメント先行が不正確になる場合
リスク/検証:
- リスク: ドキュメント先行で実装差分がズレる
- 検証方法: 変更後に docs-sync 観点で文言一致確認

候補-5
概要: 既存 `scripts/tests/test-review-cycle.sh` に最小の lane 契約テストを追加する
適用可否: Yes
仮説: 既存回帰群へ追加することで仕様逸脱を早期検知できる
反証: テストが flaky になり、保守コストが増大する
採否理由: AC3/AC4 の回帰保証に必要。既存テスト基盤を再利用できる
根拠リンク:
- scripts/tests/test-review-cycle.sh
- https://github.com/ToaruPen/Agentic-SDD/issues/126
捨て条件:
- 既存テスト設計に沿って最小追加できない場合
リスク/検証:
- リスク: テストケース過多で実行時間が増える
- 検証方法: 既存パターンに合わせた最小ケースに限定

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: #125 で追加された `review-metadata` 観測性拡張の適用境界
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/125

隣接領域-2
概要: #127 の統合契約テスト計画（ハイブリッド構成の最終整合）
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/127

抽象化-1
原理/パターン: 追加機能は既存契約と分離し、境界でのみ結合する

抽象化-2
原理/パターン: 既定値は現行互換、導入は明示 opt-in で行う

抽象化-3
原理/パターン: 仕様変更は実装・テスト・コマンドドキュメントを同時更新する

適用マッピング
- PRD: N/A（本件は運用改善 Issue）
- Epic: N/A（親 Issue #124 の段階計画に従う）
- Estimation: 変更対象を `review-cycle.sh`/テスト/コマンド文書へ限定し、工数レンジを中程度に設定

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- 実装候補を 5 件以上比較し、採否とリスクが明確化できた
- 11 項目見積もりに必要な変更対象・工数レンジの根拠が揃った

---

## 6. 探索ログ（必須）

- 何を調べたか: Issue #124/#125/#126 の AC・依存、`scripts/review-cycle.sh`、`scripts/tests/test-review-cycle.sh`、`.agent/commands/review-cycle.md`
- 何を除外したか: PRD/Epic 起点の仕様分解（本件は Issue 上で N/A 明示）、外部依存追加案
- 未解決: advisory 出力ファイル名と保持期間の最終命名規約（実装時に既存命名へ合わせる）

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: 既存契約を壊さない分離実装が必要。テスト追加範囲の見極めが工数変動要因
- 調査で減った不確実性: 主要変更点が `review-cycle.sh` + テスト + コマンド文書に収束した
- テスト計画への影響: lane on/off、既定値互換、`review.json` schema 維持、`/create-pr` 前提非破壊の回帰を追加
