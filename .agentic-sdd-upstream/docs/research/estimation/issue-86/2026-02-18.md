# Research (Estimation): issue-86

> このテンプレートは `/research estimation` コマンドで使用されます。
> 成果物は `docs/research/estimation/issue-<n>/<YYYY-MM-DD>.md` に保存します。

---

## メタ情報

- 作成日: 2026-02-18
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #86 chore: Ruff S(=Bandit相当)ルールを段階導入する

---

## 1. 調査の目的

RuffのS系ルールを段階導入する際に、誤検知と運用負荷を抑えつつCIゲート化できる実装順序と見積もり前提を確定する。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: Yes
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: No

---

## 3. 候補（必須: >= 5）

候補-1
概要: `S` を一括有効化し、既存19件を同一Issueで解消する。
適用可否: Partial
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://docs.astral.sh/ruff/rules/
- https://docs.astral.sh/ruff/settings/
捨て条件:
- 単一IssueでDoD（例外理由記録含む）を満たせない場合は分割する。
リスク/検証:
- リスク: レビュー対象が広がり、回帰確認漏れが起きやすい。
- 検証方法: 変更ファイル数とLOCがIssue粒度ルール（50-300 LOC, 1-5 files）を超えないかを見積もりで先に判定する。

候補-2
概要: ルール種別ごと（S112 -> S607 -> S603）に段階修正して導入する。
適用可否: Yes
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://docs.astral.sh/ruff/rules/try-except-continue/
- https://docs.astral.sh/ruff/rules/start-process-with-partial-path/
- https://docs.astral.sh/ruff/rules/subprocess-without-shell-equals-true/
捨て条件:
- 依存関係が強く、段階分割で差分が重複して逆に複雑化する場合は見直す。
リスク/検証:
- リスク: 後段（S603）で前段方針を再修正する可能性がある。
- 検証方法: 各段で `ruff check . --select S` を実行し、違反件数の減少と新規警告の有無を記録する。

候補-3
概要: `subprocess` 呼び出しの安全ラッパー/ユーティリティを導入し、S603対応を集約する。
適用可否: Partial
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://docs.astral.sh/ruff/rules/subprocess-without-shell-equals-true/
- https://docs.python.org/3/library/subprocess.html
捨て条件:
- ラッパー導入で既存呼び出しの可読性が下がる、または影響範囲がIssueスコープを超える場合は採用しない。
リスク/検証:
- リスク: 過剰抽象化により単純な修正よりコスト増。
- 検証方法: 既存呼び出し箇所数と共通化率を算出し、5箇所未満なら局所修正を優先する。

候補-4
概要: 例外は `# noqa: Sxxx` を最小限許可し、理由と再訪条件を文書化して運用する。
適用可否: Yes
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://docs.astral.sh/ruff/linter/#error-suppression
- https://docs.astral.sh/ruff/settings/#lint_per-file-ignores
捨て条件:
- 例外件数が増え続け、恒久的な抑止として機能しない場合は不採用。
リスク/検証:
- リスク: noqaが技術的負債化する。
- 検証方法: 例外には理由・期限・再訪トリガーを必須化し、レビュー時に未記載をrejectする。

候補-5
概要: CIでのS系ゲート化を二段階（情報表示 -> 必須）で導入する。
適用可否: Yes
仮説: h
反証: f
採否理由: r
根拠リンク:
- https://docs.astral.sh/ruff/integrations/
- https://docs.astral.sh/ruff/linter/
捨て条件:
- CI実行時間やノイズ増加が許容範囲を超える場合は段階期間を延長する。
リスク/検証:
- リスク: 早期必須化で既存開発フローを阻害する。
- 検証方法: 2週間程度の観測期間で失敗率と再実行率を記録し、閾値を満たしたら必須化する。

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: Bandit本家のB603/B607意図を参照し、Ruff S系との解釈差を把握する。
根拠リンク:
- https://bandit.readthedocs.io/en/latest/plugins/b603_subprocess_without_shell_equals_true.html
- https://bandit.readthedocs.io/en/latest/plugins/b607_start_process_with_partial_path.html

隣接領域-2
概要: コマンドインジェクション防止の一般論（OWASP）を参照し、誤検知時の判断基準を補強する。
根拠リンク:
- https://cheatsheetseries.owasp.org/cheatsheets/OS_Command_Injection_Defense_Cheat_Sheet.html

抽象化-1
原理/パターン: ルール導入は「一括適用」より「リスク順の段階適用」を優先する。

抽象化-2
原理/パターン: 例外許容はゼロ/無制限ではなく、理由と再訪条件を必須化した管理下運用にする。

抽象化-3
原理/パターン: CIゲートは警告段階を挟んで運用データを取り、必須化タイミングを決める。

適用マッピング
- PRD: N/A（本Issueは運用改善のchoreでPRD未紐付け）
- Epic: N/A（本Issueは現時点でEpic未紐付け）
- Estimation: S112/S607/S603を段階化した作業分解、noqa運用ルール整備、CI段階導入を見積もり前提にする。

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- 5候補以上で実施可否と捨て条件を定義できた
- 公式ドキュメント中心で根拠リンクを確保できた
- 見積もりに必要な不確実性（曖昧点）を列挙できた

---

## 6. 見積もりへの反映サマリ

- 不確実性/リスク: PRD/Epic未紐付け、S603対応方針（局所修正vsラッパー化）、例外運用粒度、CI必須化時期が未確定。
- 調査で減った不確実性: ルール意図（S112/S603/S607）と例外制御（noqa/per-file-ignores）を公式仕様で確認できた。
- テスト計画への影響: 実装時は `ruff check . --select S` を段階ごとに回し、件数推移と例外理由の記録を回帰証跡として扱う。
