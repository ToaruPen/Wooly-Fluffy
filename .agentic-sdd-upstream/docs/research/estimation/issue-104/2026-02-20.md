# Research (Estimation): issue-104

> このテンプレートは `/research estimation` コマンドで使用されます。
> 成果物は `docs/research/estimation/issue-<n>/<YYYY-MM-DD>.md` に保存します。

---

## メタ情報

- 作成日: 2026-02-20
- 作成者: @opencode
- 対象: 見積もり前調査
- Issue: #104 feature: Codex指摘の自動修正ループをイベント駆動で実装

---

## 1. 調査の目的

Issue #104 の AC1-AC6 を既存のテンプレ実装（workflow + shell script）へ最小差分で適用するため、
GitHub Actions/gh CLI の制約、無限ループ防止の実装パターン、失敗時証跡の出し方を確認し、見積もりの不確実性を下げる。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: Yes
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: No

---

## 3. 候補（必須: >= 5）

候補-1
概要: issue_comment 起点で PRコメントのみ処理し、Bot allowlist + opt-in label + deny-by-default を維持する
適用可否: Yes
仮説: 既存の `issue_comment` 起点と fail-closed ガードを維持し、必要情報（comment body/PR番号/event種別）を明示受け渡しすれば AC1/AC2 を満たせる
反証: payload 由来の event種別が不定で `AGENTIC_SDD_AUTOFIX_CMD` 側が解釈不能、または PR以外誤起動が残る場合は不採用
採否理由: 既存実装に最小変更で入れられ、対象外イベントの早期終了方針とも整合するため
根拠リンク:
- https://docs.github.com/actions/using-workflows/events-that-trigger-workflows#issue_comment
- https://docs.github.com/en/webhooks/webhook-events-and-payloads#issue_comment
- https://github.com/ToaruPen/Agentic-SDD/issues/103
捨て条件:
- workflow起動条件を増やして複数イベントを一括処理する必要が判明した場合
リスク/検証:
- リスク: payload差異で event種別の正規化に漏れが出る
- 検証方法: サンプルpayloadを使ったスクリプト単体検証で `issue_comment` / 非PRコメント分岐を確認

候補-2
概要: `AGENTIC_SDD_AUTOFIX_CMD` 実行前に入力を環境変数/一時ファイルで固定フォーマット化する
適用可否: Yes
仮説: 既存の `AGENTIC_SDD_AUTOFIX_INPUT_PATH` に加えて `PR番号/event種別/comment本文` を明示受け渡しすれば、外部コマンド側の解析が安定する
反証: コメント本文のエスケープや長文で受け渡しが壊れる場合は設計見直しが必要
採否理由: 既に一時ファイル受け渡しの土台があり、引数インジェクション回避にも寄与する
根拠リンク:
- https://docs.github.com/en/actions/learn-github-actions/variables
- https://github.com/ToaruPen/Agentic-SDD/blob/main/templates/ci/github-actions/scripts/agentic-sdd-pr-autofix.sh
捨て条件:
- 外部コマンド側仕様が「標準入力のみ許可」に固定された場合
リスク/検証:
- リスク: 受け渡し項目増加で互換性を壊す
- 検証方法: 未設定時の fail-fast メッセージと設定時の実行ログを比較

候補-3
概要: PRの head ブランチに checkout して差分がある場合のみ commit/push する
適用可否: Yes
仮説: `gh pr view` で headRepository/headRefName を取得し、fork除外 + no-diff no-op を徹底すれば AC3 を満たせる
反証: base側チェックアウト状態と head ブランチ状態の整合が取れず誤pushが起きる場合は不採用
採否理由: 既存スクリプトに同等の処理があり、追加は SHA 出力と分岐強化中心で済むため
根拠リンク:
- https://cli.github.com/manual/gh_pr_view
- https://git-scm.com/docs/git-push
- https://github.com/ToaruPen/Agentic-SDD/issues/104
捨て条件:
- fork PR も対象に含める方針へ変更された場合
リスク/検証:
- リスク: branch protection でpush不可時の挙動が曖昧
- 検証方法: push失敗時に patch artifact とコメント理由が残ることをテスト

候補-4
概要: commit/push 成功時に head SHA を含む `@codex review` コメントを自動投稿する
適用可否: Yes
仮説: 成功パスで `git rev-parse HEAD` を取得して固定文面コメントを投稿すれば AC4 を満たせる
反証: コメント文面仕様が `/codex-pr-review` と整合せず bot 側が無視する場合は再設計が必要
採否理由: 既存運用コマンドの文面規約があり、再利用しやすい
根拠リンク:
- https://cli.github.com/manual/gh_pr_comment
- https://github.com/ToaruPen/Agentic-SDD/blob/main/.agent/commands/codex-pr-review.md
捨て条件:
- Codex再依頼トリガーがコメント以外（API専用）へ変わる場合
リスク/検証:
- リスク: 自己投稿コメントが次イベントを誘発してループする
- 検証方法: marker判定 + allowlist判定で自己投稿時に no-op となることを確認

候補-5
概要: 無限ループ防止を marker/重複抑止/最大反復回数/concurrency の複合で実装する
適用可否: Yes
仮説: 既存 marker コメント識別と `AGENTIC_SDD_AUTOFIX_MAX_ITERS` に加え、同一PRの並列実行抑止で AC5 を満たせる
反証: 並列 run が同時に commit しうる競合を防げない場合は追加ロックが必要
採否理由: workflow 側に concurrency が既にあり、script 側も marker数カウント実装済み
根拠リンク:
- https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs
- https://github.com/ToaruPen/Agentic-SDD/blob/main/templates/ci/github-actions/.github/workflows/agentic-sdd-pr-autofix.yml
捨て条件:
- 複数workflowにまたがる再実行競合が新たに発生する場合
リスク/検証:
- リスク: max iteration 到達後の停止理由が利用者に伝わらない
- 検証方法: 停止時コメントに `current/max` と run URL を含める

候補-6
概要: 失敗時に「原因・対象SHA・実行URL」を fail-fast で残す
適用可否: Partial
仮説: 既存の `die`/`trap` 投稿に対象SHAを加えれば AC6 を満たせる
反証: 失敗時点で対象SHA未確定（checkout前失敗など）のケースが多く、常に値を出せない場合は部分適用に留まる
採否理由: 実行URLとエラー出力は既存で出せるが、SHAは失敗ポイントごとに扱い分けが必要なため
根拠リンク:
- https://docs.github.com/en/actions/monitoring-and-troubleshooting-workflows/using-workflow-run-logs
- https://github.com/ToaruPen/Agentic-SDD/blob/main/templates/ci/github-actions/scripts/agentic-sdd-pr-autofix.sh
捨て条件:
- checkout前失敗でも SHA 必須という要件が厳密化された場合
リスク/検証:
- リスク: SHAが空のまま投稿され調査性が下がる
- 検証方法: `BASE_SHA/HEAD_SHA/UNKNOWN` の3値ポリシーを定義し、全失敗経路で確認

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
概要: ChatOps系の bot コマンド実行における権限制御（allowlist + opt-in + deny-by-default）
根拠リンク:
- https://docs.github.com/en/actions/security-for-github-actions/security-guides/automatic-token-authentication
- https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions

隣接領域-2
概要: CI自己誘発ループを避けるためのイベント設計（marker + actor判定 + 反復上限）
根拠リンク:
- https://docs.github.com/actions/using-workflows/events-that-trigger-workflows
- https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/control-the-concurrency-of-workflows-and-jobs

抽象化-1
原理/パターン: fail-closed, explicit opt-in, least privilege

抽象化-2
原理/パターン: idempotency, deduplication, bounded retry

抽象化-3
原理/パターン: immutable evidence (SHA/URL), no-op on no diff

適用マッピング
- PRD: FR-6 の「明示opt-in + deny-by-default + allowlist + 証跡コメント」を満たす実装制約を具体化
- Epic: templates/ci の workflow/script 責務分離（トリガー制御はworkflow、fail-fast実行制御はscript）を補強
- Estimation: AC4/AC6（再依頼コメントと失敗証跡）に追加工数を配分し、line range を 150-300 LOC で見積もる根拠を得た

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- AC1-AC6 の実装論点が候補5件以上で列挙できる
- fail-fast とループ防止の検証観点がテスト計画に落とし込める

---

## 6. 探索ログ（必須）

- 何を調べたか: Issue #103/#104、PRD/Epic、既存 `agentic-sdd-pr-autofix` workflow/script、GitHub Actionsイベント/Concurrency/Token関連Docs
- 何を除外したか: 外部キュー導入・長時間ワーカー化（PRDスコープ外）、fork PR自動push対応（MVP外）
- 未解決: `@codex review` 文面の最終フォーマット統一（`/codex-pr-review` と同一テンプレ化するか）

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: 失敗経路ごとの SHA 証跡設計、自己誘発ループの取りこぼし、コメント再依頼文面の運用整合
- 調査で減った不確実性: AC1-AC3/AC5 は既存実装の延長で対応可能、主な増分は AC4/AC6 と周辺テスト
- テスト計画への影響: script の分岐（対象外/成功/no-op/失敗）をケース分割し、SHA付き再依頼と停止条件を検証対象に追加
