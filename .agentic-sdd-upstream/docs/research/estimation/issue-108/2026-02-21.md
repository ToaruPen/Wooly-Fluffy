# Research (Estimation): issue-108

> このテンプレートは `/research estimation` コマンドで使用されます。
> 成果物は `docs/research/estimation/issue-<n>/<YYYY-MM-DD>.md` に保存します。

---

## メタ情報

- 作成日: 2026-02-21
- 作成者: @SankenBisha
- 対象: 見積もり前調査
- Issue: #108 refactor: /codex-pr-review を /pr-bots-review へ全面刷新し、レビューBot設定を外部化する

---

## 1. 調査の目的

Issue #108 の AC1-AC5 を満たすため、既存の review-loop/autofix-loop の設定SoTを崩さずに
コマンド名刷新とレビュー再依頼メンション外部化を行う実装経路を特定し、見積もりの不確実性を下げる。

---

## 2. 新規性判定（発火条件）

- 直接の先行事例が2件未満: No
- PRD/Epic/Issue に Unknown/曖昧さが残る: Yes
- Q6-5〜8（PII/監査/性能/可用性）のいずれかが Yes: No

---

## 3. 候補（必須: >= 5）

候補-1
概要: `/codex-pr-review` を `/pr-bots-review` へ名称置換し、aliasを作らず単一導線化する
適用可否: Yes
仮説: コマンド正本（`.agent/commands`）と生成経路（`scripts/agentic-sdd/sync-agent-config.sh`）を同時更新すれば、旧名称の再注入を防いで AC1/AC4 を満たせる
反証: 同期スクリプトの分岐やREADME索引に旧名称が1箇所でも残り、再同期で戻る場合は不採用
採否理由: 変更点が明確で、Issue本文の変更対象リストと一致するため
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/108
- scripts/agentic-sdd/sync-agent-config.sh
捨て条件:
- 後方互換alias必須の運用要件が追加された場合
リスク/検証:
- リスク: `.opencode/` / `.codex/` の生成物へ旧名称が残る
- 検証方法: 同期実行後に repo 全体検索で `codex-pr-review` 残存有無を確認

候補-2
概要: レビュー再依頼メンションを単一環境変数（例: `AGENTIC_SDD_PR_REVIEW_MENTION`）へ統一する
適用可否: Yes
仮説: autofix script、コマンド文書、テスト期待値の参照元を1変数へ集約すれば AC2 を満たせる
反証: runtime と docs/tests で別フォーマットが必要で単一値運用できない場合は不採用
採否理由: 既存でも `CODEX_BOT_LOGINS` が設定SoTとして機能しており、同じパターンで拡張できるため
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/108
- templates/ci/github-actions/scripts/agentic-sdd-pr-autofix.sh
- scripts/agentic-sdd/tests/test-pr-autofix-template.sh
捨て条件:
- Bot再依頼がコメント以外（専用API呼び出し）へ変更された場合
リスク/検証:
- リスク: 変数未設定時に silently default して設定漏れに気づけない
- 検証方法: 未設定時は fail-fast で明示エラーとなるかをテスト

候補-3
概要: allowlist 設定（review-loop/autofix-loop）を名称・既定値・未設定時挙動まで整合させる
適用可否: Yes
仮説: `CODEX_BOT_LOGINS` と `AGENTIC_SDD_AUTOFIX_BOT_LOGINS` の運用差を明文化し、未設定時を fail-fast に寄せれば AC3 を満たせる
反証: 既存利用者の環境で fail-fast が過剰破壊となり移行不能な場合は Partial に下げる
採否理由: Issue #108 が「運用導線とCI挙動への影響」を明示しており、設定ポリシーの整合が主要論点のため
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/108
- scripts/agentic-sdd/codex-review-event.sh
- scripts/agentic-sdd/watch-codex-review.sh
- templates/ci/github-actions/scripts/agentic-sdd-pr-autofix.sh
捨て条件:
- 互換維持方針で当面は warn-only が必須と判断された場合
リスク/検証:
- リスク: fail-fast 追加で既存ワークフローが停止する
- 検証方法: 設定あり/なしの2ケースで exit code とメッセージ内容を確認

候補-4
概要: ドキュメント更新対象を README/AGENTS/.agent コマンド群へ限定し、CHANGELOGは履歴用途として除外する
適用可否: Yes
仮説: AC5 の除外条件（CHANGELOG履歴記述は除く）に沿って対象を限定すれば、スコープ逸脱を防ぎつつ残存防止を達成できる
反証: 履歴参照以外の文脈で CHANGELOG が運用導線に使われている場合は再評価が必要
採否理由: Issue本文のACが明示している除外条件に一致するため
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/108
- README.md
- AGENTS.md
捨て条件:
- 監査要件として CHANGELOG の現行語彙統一が追加要求された場合
リスク/検証:
- リスク: docs差分が広くレビュー漏れが起きる
- 検証方法: 旧名称・旧メンションのrepo検索結果を証跡として残す

候補-5
概要: テストはテンプレスクリプト単体と同期スクリプト回帰に集中し、生成再注入を回帰で検知する
適用可否: Yes
仮説: `test-pr-autofix-template.sh` と `sync-agent-config.sh` 周辺の回帰テストで、AC2/AC4 を高確度で保証できる
反証: 既存テストが文字列固定依存で大量修正になり、Issue粒度を超過する場合は分割が必要
採否理由: 変更影響の中心がテンプレ文言・生成経路であり、最短で効果的な検証点のため
根拠リンク:
- https://github.com/ToaruPen/Agentic-SDD/issues/108
- scripts/agentic-sdd/tests/test-pr-autofix-template.sh
- scripts/agentic-sdd/worktree.sh
捨て条件:
- E2E（実PR作成）まで必須と判断された場合
リスク/検証:
- リスク: docs更新だけ成功して runtime fail-fast が未検出
- 検証方法: シェルテストで未設定時失敗と設定時成功を分離検証

候補-6
概要: review comment トリガー仕様は GitHub公式イベント仕様に合わせ、issue_comment のPR判定前提を維持する
適用可否: Partial
仮説: issue_comment ペイロード依存の設計を保てば既存運用を壊さずに移行可能
反証: GitHub 側のイベント仕様差異（特定条件でPRコメントが発火しない）が実運用で頻発する場合は trigger 設計見直しが必要
採否理由: 仕様確認は必要だが、本Issueの主対象は名称/設定SoTでありトリガー全面再設計までは不要なため
根拠リンク:
- https://docs.github.com/actions/using-workflows/events-that-trigger-workflows#issue_comment
- https://docs.github.com/en/webhooks/webhook-events-and-payloads#issue_comment
捨て条件:
- 現行workflowで再現可能な取りこぼしが確認された場合
リスク/検証:
- リスク: まれなコメント種別で再依頼が起動しない
- 検証方法: 既存テスト範囲外は運用メモへ既知制約として明記

---

## 4. 隣接領域探索（新規性が高い場合は必須）

隣接領域-1
領域: 既存 review-cycle の fail-closed 運用
候補との関係: 候補-3（allowlist未設定時 fail-fast）の妥当性確認
調査結果: review-loop 側（`scripts/agentic-sdd/codex-review-event.sh`）も未設定時に非0終了へ寄せる方針が既に採用されており、autofix 側も同ポリシーにそろえるのが一貫的
根拠:
- https://github.com/ToaruPen/Agentic-SDD/issues/108

隣接領域-2
領域: GitHub Actions の issue_comment / review 系イベント仕様
候補との関係: 候補-6（イベント前提の維持）
調査結果: issue_comment は PR 上コメントも対象にできるため、現行の PR判定 + allowlist フィルタ方針を維持したまま移行可能
根拠:
- https://docs.github.com/actions/using-workflows/events-that-trigger-workflows#issue_comment
- https://docs.github.com/en/webhooks/webhook-events-and-payloads#issue_comment

適用マッピング:
- 隣接領域-1 -> 候補-3（allowlist未設定 fail-fast を review/autofix で整合）
- 隣接領域-2 -> 候補-6（issue_comment 前提を維持しつつ bot 設定外部化を適用）

---

## 5. 止め時（必須）

タイムボックス: 60min
打ち切り条件:
- AC1-AC5 の各ACに対して実装候補と検証点を1つ以上割り当てられる
- 変更対象ファイルを runtime/docs/tests/生成経路の4系統で列挙できる

---

## 6. 探索ログ（必須）

- 何を調べたか: `gh issue view 108`、`gh issue develop --list 108`、PRD/Epic、`codex-pr-review`/`@codex review` の全体検索、GitHub Actions issue_comment 公式ドキュメント
- 何を除外したか: review bot 実装そのもの（外部サービス側仕様）、PRD/Epic 全面改訂（Issueスコープ外）
- 未解決（調査時点）: レビュー再依頼メンション変数名の最終命名と既定値ポリシー
  - 実装時確定: `AGENTIC_SDD_PR_REVIEW_MENTION`（必須、既定値なし。推奨設定例: `@pr-bots review`）

---

## 7. 見積もりへの反映サマリ

- 不確実性/リスク: 設定未整備時 fail-fast の厳しさ、生成経路での旧名称再注入、テスト期待値更新漏れ
- 調査で減った不確実性: 主要変更箇所（`.agent`/`scripts`/`templates`/`README`/`AGENTS`/テスト）が特定でき、先行Issue #103/#104 の延長で実装可能
- テスト計画への影響: 文字列置換だけでなく「未設定時の失敗」と「再同期後の再注入なし」を検証項目へ追加する
